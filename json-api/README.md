# Sketch-thru-Plan JSON API

Sketch-thru-Plan (STP) provides a high-level [JSON-RPC](https://www.jsonrpc.org/specification) API that can be used to access services using languages for which an SDK may not be available.

## API access to/from STP

Events generated by client applications are normally forwarded to STP via Websockets. Other  mechanisms may be supported, in cases where STP is embedded in a larger server-side application that uses other communication mechanisms, for example event queues.

Sample code (in typescript) demonstrating how the standard STP Websockets connector is implemented can be found under [samples/typescript/connector-plugin](../typescript/connector-plugin).

Independently of the mechanism, communication with STP is required to be two-way, to provide ways for a client service to communicate events, such as user sketches and speech, but also receive events generated by other services, for example , events signaling that new symbols have been added.

## Outgoing message format

The JSON API mirrors the SDKs very closely. In fact, the SDKs offer a thin layer over the JSON API for convenience when using the services in javascript or .NET.

* method - Name of the event - same as used in the SDK
* params - Event parameters - same order and type as the SDK

```javascript
{
    "jsonrpc": "2.0",
    "method":"SendPenDown",
    "params":{
        "location": {
            "lat":58.95657852665255,
            "lon":11.175978030896498},
        "timestamp":"2020-10-27T20:50:30.584Z"
    }
}
```

## Returns

Most messages are `Informs`, and do not have any explicit return types. They update the state of the system, which may (or may not) result in some other component generating additional messages. For example, sketch and speech (separate) Informs may result in a new symbol being created or modified, which will be propagated via messages. If the sketch and speech could not be matched with high enough confidence though, no recognition messages are issued. Client's should therefore not rely on the generation of a response when Informs are used.

Queries are dealt with via `Requests`. These messages always produce a response, and are in this sense equivalent to a remote procedure call, even if the mechanism remains asynchronous. Results are provided in an array of objects. 

```javascript
{
  "id": 1,
  "jsonrpc": "2.0",
  "result": [
    {
      "fsTYPE": "coa",
      "poid": "id7J5ZJ1GVNQUNE"
      "name": "R1",
      "type": "hostile",
      "creator_role": "s2",
    }
    {
      "fsTYPE": "coa",
      "poid": "idADPSPP8Q29CGF"
      "name": "B1",
      "type": "friend",
      "creator_role": "s3",
    }
  ]
}
```

In case of an unsuccessful request, an error response is returned:

```javascript
{
    "jsonrpc": "2.0", 
    "id": "5",
    "error": {
        "code": -32601, 
        "message": "Invalid argument: expected a numeric id"
    }
}
```

## Incoming message format

STP components operate as both consumers and producers of events/messages. When connecting to STP, a component declares the events it is able to handle. STPs publish/subscribe mechanism then notifies components that are subscribed whenever relevant events occur. In the SDK, subscription is done automatically, based on the handlers the component instantiated before connecting to STP (see the [connector plugin discussion](../typescript/connector-plugin))

Incoming messages follow the same format as the outgoing ones, with a `method` property indicating the type, and `params` providing event-specific parameters. In the SDK, these corresponds to events the client subscribes to, prefixed with "on", for example `onSymbolAdded`. See the [javascript quickstarts](../../quickstart) for examples.

```javascript
{
    "jsonrpc": "2.0",
    "method":"SymbolAdded",
    "params":{
        "symbol":{
            "fsTYPE":"unit",
            "poid":"idDS6X03AGXT68E",
            "creatorRole":"s3",
            "confidence":0.820098781593131,
            "alt":0,
            "sidc":{
                "partA":"1003100015",
                "partB":"1205010000",
                "symbolSet":"10",
                "legacy":"SFGPUCRVA--E---"
            },
            "location":{
                "fsTYPE":"unit",
                "shape":"point",
                "coords":[{"lon":11.1648166167093,"lat":58.9486323288235}],
                "width":0.0,
                "altitude":0.0,
                "radius":0.0,
                "candidatePoids":[]
            },
            "shortDescription":"A/3-1",
            "description":"ARMORED CAVALRY RECON COMPANY",
            "fullDescription":"FRIENDLY ARMORED CAVALRY RECON COMPANY A/3-1",
            "affiliation":"friend",
            "echelon":"company",
            "parent":"3-1",
            "designator1":"A",
            "designator2":null,
            "status":"present",
            "modifier":"none",
            "strength":"none",
            "timeFrom":null,
            "timeTo":null,
            "altitude":null,
            "minAltitude":null,
            "maxAltitude":null
        },
        "isUndo":false
    }
}
```

## Schema

**UNDER CONSTRUCTION** An [OpenRPC](https://github.com/open-rpc) definition of the api can be found in [sketch-thru-plan-api.json](sketch-thru-plan-api.json)
