{"version":3,"file":"arcgis.js","sourceRoot":"","sources":["../../../src/arcgis.ts"],"names":[],"mappings":"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","sourcesContent":["// ArcGIS JS API integration via AMD loader present on the page\r\n// Assumes the application has loaded the ArcGIS JS API and its AMD `require` function globally.\r\n// Example: <script src=\"https://js.arcgis.com/4.29/\"></script>\r\n\r\nimport { IMapAdapter } from '../../interfaces/IMapAdapter';\r\n\r\ndeclare const require: any;\r\n\r\nexport class ArcGISMap implements IMapAdapter {\r\n  // Events\r\n  onStrokeStart?: (location: { lat: number; lon: number }, timestamp: string) => void;\r\n  onStrokeCompleted?: (\r\n    pixelBoundsWindow: { width: number; height: number },\r\n    topLeftGeoMap: { lat: number; lon: number },\r\n    bottomRightGeoMap: { lat: number; lon: number },\r\n    strokePoints: Array<{ lat: number; lon: number }>,\r\n    timeStrokeStart: string,\r\n    timeStrokeEnd: string,\r\n    intersectedPoids: string[]\r\n  ) => void;\r\n  onSelection?: (symbol: any) => void;\r\n\r\n  // Basic map properties\r\n  apiKey: string | null; // not used by ArcGIS AMD loader, kept for parity\r\n  mapCenter: { lat: number; lon: number };\r\n  zoomLevel: number;\r\n  mapDivId: string;\r\n\r\n  private mapRef: any; // esri/Map\r\n  private viewRef: any; // esri/views/MapView\r\n  private symbolLayerPoint: any; // esri/layers/FeatureLayer\r\n  private symbolLayerMultipoint: any; // esri/layers/FeatureLayer\r\n  private symbolLayerLine: any; // esri/layers/FeatureLayer\r\n  private symbolLayerPolygon: any; // esri/layers/FeatureLayer\r\n  private inkLayer: any; // esri/layers/GraphicsLayer\r\n  private inkLayerView: any; // esri/views/layers/GraphicsLayerView (not used for refresh)\r\n  private drawing: boolean = false;\r\n  private strokeStartTs: string = '';\r\n  private strokeGraphic: any; // esri/Graphic (polyline)\r\n  private assets: Map<string, Array<any>> = new Map();\r\n  private nextObjectId: number = 1; // For unique objectid generation\r\n\r\n  // Optional: allow overriding the military dictionary via portal item id\r\n  private milDictionaryStyleUrl: string | null;\r\n  private milDictionaryPortalItemId: string | null;\r\n\r\n  constructor(apiKey: string | null, mapDivId: string, mapCenter: { lat: number; lon: number }, zoomLevel: number, options?: { mil2525StyleUrl?: string; mil2525PortalItemId?: string }) {\r\n    this.apiKey = apiKey ?? null;\r\n    this.mapDivId = mapDivId;\r\n    this.mapCenter = mapCenter;\r\n    this.zoomLevel = zoomLevel;\r\n    // Renderer source can be provided as styleUrl or portalItem id; allow override via options and leave null by default to avoid bad URLs\r\n    this.milDictionaryStyleUrl = options?.mil2525StyleUrl ?? null;\r\n    this.milDictionaryPortalItemId = options?.mil2525PortalItemId ?? null;\r\n  }\r\n\r\n  load = async () => {\r\n    const mapDiv = document.getElementById(this.mapDivId);\r\n    if (!mapDiv) throw new Error(`Html page must contain a '#${this.mapDivId}' div`);\r\n\r\n    return new Promise<void>((resolve, reject) => {\r\n      try {\r\n        require([\r\n          'esri/Map',\r\n          'esri/views/MapView',\r\n          'esri/layers/FeatureLayer',\r\n          'esri/renderers/DictionaryRenderer',\r\n          'esri/layers/GraphicsLayer',\r\n          'esri/Graphic',\r\n          'esri/geometry/Point',\r\n          'esri/geometry/Multipoint',\r\n          'esri/geometry/Polyline',\r\n          'esri/geometry/Polygon',\r\n          'esri/geometry/projection',\r\n          'esri/geometry/SpatialReference',\r\n          'esri/config'\r\n        ], (\r\n          Map: any,\r\n          MapView: any,\r\n          FeatureLayer: any,\r\n          DictionaryRenderer: any,\r\n          GraphicsLayer: any,\r\n          Graphic: any,\r\n          Point: any,\r\n          Multipoint: any,             \r\n          Polyline: any,\r\n          Polygon: any,\r\n          projection: any,\r\n          SpatialReference: any,\r\n          esriConfig: any          \r\n        ) => {\r\n          // Apply API key if provided (required for Esri basemaps/services)\r\n          if (this.apiKey && esriConfig) {\r\n            esriConfig.apiKey = this.apiKey;\r\n          }\r\n\r\n          // Client-side feature layers for symbols using MIL-STD-2525 DictionaryRenderer\r\n          // Note: fields array is optional for client-side layers; included for schema clarity\r\n          // Field names match StpSymbol properties (using object directly, no flattening needed)\r\n          const fields = [\r\n            // Local layers require explicit setting of objectid\r\n            { name: 'objectid', type: 'oid' },\r\n            // Maps stpSYmbol's deeltaSIDC, whihc is a computed getter and is not directly accessible via \r\n            // fieldMap without this explicit property for renderer mapping\r\n            { name: 'symbolId', type: 'string' },    \r\n            // All StpSymbol properties are available since we use the object directly\r\n            // Only defining the key ones used by fieldMap and commonly needed\r\n            { name: 'poid', type: 'string' },\r\n            { name: 'designator1', type: 'string' },     \r\n            { name: 'parent', type: 'string' },         \r\n            { name: 'echelon', type: 'string' },         \r\n            { name: 'status', type: 'string' },          \r\n            { name: 'affiliation', type: 'string' },     \r\n            { name: 'modifier', type: 'string' },        \r\n            { name: 'timeFrom', type: 'date' },          \r\n            { name: 'timeTo', type: 'date' },            \r\n            { name: 'minAltitude', type: 'double' },     \r\n            { name: 'maxAltitude', type: 'double' },\r\n            { name: 'description', type: 'string' },\r\n            { name: 'fullDescription', type: 'string' }\r\n          ];\r\n\r\n          // Set url based on provided options (prioritize explicit ones)\r\n          let dictionaryUrl;\r\n          if (this.milDictionaryStyleUrl) {\r\n            dictionaryUrl = this.milDictionaryStyleUrl;\r\n            console.info('ArcGISMap: Using MIL-STD-2525 styleUrl:', dictionaryUrl);\r\n          } else if (this.milDictionaryPortalItemId) {\r\n            dictionaryUrl = this.milDictionaryPortalItemId;  // item ID string is acceptable\r\n            console.info('ArcGISMap: Using MIL-STD-2525 portalItem ID:', dictionaryUrl);\r\n          } else {\r\n            // Fallback to MIL-STD-2525D with ordered anchor points support\r\n            // Or Change 1: \"f45922a0e20e4d3189a4099667bec656\"\r\n            dictionaryUrl = \"https://www.arcgis.com/sharing/rest/content/items/d815f3bdf6e6452bb8fd153b654c94ca\";\r\n            console.info('ArcGISMap: Using default MIL-STD-2525D full URL:', dictionaryUrl);\r\n          }\r\n\r\n          // Renderer configuration with fieldMap tailored to StpSymbol properties\r\n          const renderer = new DictionaryRenderer({\r\n            url: dictionaryUrl, // symbolStyle: symbolStyle,\r\n            fieldMap: {\r\n              sidc: \"symbolId\", // Maps to StpSymbol.deltaSIDC\r\n              uniquedesignation: \"designator1\", // Maps StpSymbol.designator1\r\n              higherformation: \"parent\", // Maps StpSymbol.parent\r\n              datetimevalid: \"timeFrom\", // Maps StpSymbol.timeFrom\r\n              datetimeexpired: \"timeTo\", // Maps StpSymbol.timeTo\r\n              z: \"minAltitude\", // Maps StpSymbol.minAltitude\r\n              z2: \"maxAltitude\", // Maps StpSymbol.maxAltitude\r\n            },\r\n            config: {\r\n              model: \"ORDERED ANCHOR POINTS\"  // Enables ordered anchor point interpretation for compatible symbols\r\n            }\r\n          });\r\n\r\n          // Layers for different geometry types\r\n          // Dummy point graphic for validation (use a neutral location, e.g., 0,0)\r\n          const dummyPointGraphic = new Graphic({\r\n            geometry: new Point({\r\n              longitude: 0,\r\n              latitude: 0,\r\n              spatialReference: { wkid: 4326 }\r\n            }),\r\n            attributes: { objectid: 0 }  // Minimal required attribute\r\n          });\r\n\r\n          // For point layer\r\n          this.symbolLayerPoint = new FeatureLayer({\r\n            title: 'STP Symbols (Point)',\r\n            source: [dummyPointGraphic],  // ← Add dummy\r\n            fields,\r\n            objectIdField: 'objectid',\r\n            geometryType: 'point',\r\n            spatialReference: { wkid: 4326 },\r\n            renderer: renderer\r\n          });\r\n\r\n          // For multipoint layer (similar dummy, using Multipoint with one empty-ish point)\r\n          const dummyMultipointGraphic = new Graphic({\r\n            geometry: new Multipoint({\r\n              points: [[0, 0]],\r\n              spatialReference: { wkid: 4326 }\r\n            }),\r\n            attributes: { objectid: 0 }\r\n          });\r\n\r\n          this.symbolLayerMultipoint = new FeatureLayer({\r\n            title: 'STP Symbols (Multipoint)',\r\n            source: [dummyMultipointGraphic],  // ← Add dummy\r\n            fields,\r\n            objectIdField: 'objectid',\r\n            geometryType: 'multipoint',\r\n            spatialReference: { wkid: 4326 },\r\n            renderer: renderer\r\n          });          \r\n          this.symbolLayerLine = new FeatureLayer({\r\n            title: 'STP Symbols (Line)',\r\n            source: [],\r\n            fields,\r\n            objectIdField: 'objectid',\r\n            geometryType: 'polyline',\r\n            spatialReference: { wkid: 4326 },\r\n            renderer: renderer\r\n          });\r\n          this.symbolLayerPolygon = new FeatureLayer({\r\n            title: 'STP Symbols (Area)',\r\n            source: [],\r\n            fields,\r\n            objectIdField: 'objectid',\r\n            geometryType: 'polygon',\r\n            spatialReference: { wkid: 4326 },\r\n            renderer: renderer\r\n          });\r\n\r\n          // Create map + view\r\n          this.mapRef = new Map({ basemap: 'topo-vector' });\r\n          this.viewRef = new MapView({\r\n            container: mapDiv,\r\n            map: this.mapRef,\r\n            center: [this.mapCenter.lon, this.mapCenter.lat],\r\n            zoom: this.zoomLevel,\r\n            constraints: { snapToZoom: false }\r\n          });\r\n\r\n\r\n          this.viewRef.when(() => {\r\n            // Ink layer for freehand drawing\r\n            this.inkLayer = new GraphicsLayer({ title: 'Ink' });\r\n            console.debug('InkLayer created:', this.inkLayer);  // Should log a valid object\r\n            this.mapRef.add(this.inkLayer);  // Add immediately - no need for function check\r\n            console.debug('InkLayer created and added to map');\r\n            // 2. Immediately request the layer view and cache it\r\n            this.viewRef.whenLayerView(this.inkLayer).then((layerView) => {\r\n              this.inkLayerView = layerView;\r\n              console.debug('InkLayerView is now ready');\r\n            }).catch(err => {\r\n              console.error('Failed to obtain inkLayerView:', err);\r\n            });\r\n            // Cursor hint similar to other adapters\r\n            const container = this.viewRef.container as HTMLElement;\r\n            if (container && container.style) container.style.cursor = 'crosshair';\r\n            // Load projection module for coordinate transformations\r\n            projection.load();\r\n            // Symbol layers\r\n            this.mapRef.addMany([this.symbolLayerPoint, this.symbolLayerMultipoint, this.symbolLayerLine, this.symbolLayerPolygon]);\r\n            // Suppress panning during drags\r\n            this.viewRef.on(\"drag\", (event: any) => {\r\n              event.stopPropagation();\r\n            });\r\n          });\r\n\r\n          // Basic click selection support via hitTest\r\n          this.viewRef.on('click', async (event: any) => {\r\n            try {\r\n              const response = await this.viewRef.hitTest(event);\r\n              const graphic = response?.results?.find((r: any) => {\r\n                const lyr = r.graphic?.layer;\r\n                return lyr === this.symbolLayerPoint || lyr === this.symbolLayerLine || lyr === this.symbolLayerPolygon;\r\n              })?.graphic;\r\n              if (graphic && this.onSelection) {\r\n                // graphic.attributes IS the StpSymbol object directly\r\n                this.onSelection.call(this, graphic.attributes);\r\n              }\r\n            } catch (_) {\r\n              /* ignore */\r\n            }\r\n          });\r\n\r\n          // Freehand drawing\r\n          this.viewRef.on('pointer-down', (e: any) => {\r\n            if (e.button !== 0) return; // left button only\r\n            // Prevent the default pan/zoom behavior\r\n            e.stopPropagation();\r\n            e.preventDefault();         // often both are needed for reliability\r\n            this.drawing = true;\r\n            this.strokeStartTs = this.getIsoTimestamp();\r\n            const mapPoint = this.viewRef.toMap({ x: e.x, y: e.y });\r\n            const start = { lat: mapPoint.latitude, lon: mapPoint.longitude };\r\n            this.onStrokeStart?.call(this, start, this.strokeStartTs);\r\n            //this.clearInk();\r\n\r\n            const polyline = new Polyline({\r\n                paths: [[[mapPoint.longitude, mapPoint.latitude]]],  // Initial path with first point\r\n                spatialReference: { wkid: 4326 }\r\n              });\r\n            this.strokeGraphic = new Graphic({\r\n              geometry: polyline,\r\n              symbol: { type: 'simple-line', color: '#8B0000', width: 2 }\r\n            });\r\n            this.inkLayer.add(this.strokeGraphic);\r\n            console.debug('Stroke started, initial path:', polyline.paths);          \r\n          });\r\n\r\n          this.viewRef.on('pointer-move', (e: any) => {\r\n            if (!this.drawing || !this.strokeGraphic) return;\r\n            e.stopPropagation();      // prevents any other move handlers from interfering\r\n            const mapPoint = this.viewRef.toMap({ x: e.x, y: e.y });\r\n            \r\n            // Get current paths and add new point\r\n            const currentGeom = this.strokeGraphic.geometry;\r\n            const currentPaths = currentGeom.paths || [[]];\r\n            const updatedPaths = [...currentPaths];\r\n            updatedPaths[0] = [...(updatedPaths[0] || []), [mapPoint.longitude, mapPoint.latitude]];\r\n            \r\n            // Create new geometry object (don't mutate in place)\r\n            const newGeometry = new Polyline({\r\n              paths: updatedPaths,\r\n              spatialReference: { wkid: 4326 }\r\n            });\r\n            \r\n            // Update the graphic's geometry\r\n            this.strokeGraphic.geometry = newGeometry;\r\n            console.debug('Stroke move, path length:', updatedPaths[0].length);\r\n          });\r\n\r\n          const finish = (e: any) => {\r\n            if (!this.drawing) return;\r\n            this.drawing = false;\r\n            const strokeEnd = this.getIsoTimestamp();\r\n            const geom = this.strokeGraphic?.geometry;\r\n            \r\n            let coords: Array<{ lat: number; lon: number }> = [];\r\n            if (geom?.paths?.[0]?.length > 0) {\r\n              coords = geom.paths[0].map((p: any) => ({ lat: p[1], lon: p[0] }));\r\n            }\r\n            if (coords.length === 1) coords.push(coords[0]);\r\n\r\n            const extent = this.viewRef?.extent;\r\n            const mapDivEl = document.getElementById(this.mapDivId) as HTMLElement;\r\n            const sizePixels = { width: mapDivEl.clientWidth, height: mapDivEl.clientHeight };\r\n            \r\n            const { topLeft, bottomRight } = this.convertExtentToWGS84(extent, Point, SpatialReference, projection);\r\n\r\n            this.onStrokeCompleted?.call(this, sizePixels, topLeft, bottomRight, coords, this.strokeStartTs, strokeEnd, []);\r\n          };\r\n          this.viewRef.on('pointer-up', finish);\r\n          document.addEventListener('mouseup', finish);\r\n\r\n          resolve();\r\n        });\r\n      } catch (err) {\r\n        reject(err);\r\n      }\r\n    });\r\n  };\r\n\r\n  addFeature = (symbolGeoJSON: any) => {\r\n    if (!symbolGeoJSON) return;\r\n    require(['esri/Graphic', 'esri/geometry/Multipoint'], (Graphic: any, Multipoint: any) => {\r\n      const geom = symbolGeoJSON.geometry;\r\n      const stpSymbol = symbolGeoJSON.properties.symbol;  // StpSymbol instance\r\n\r\n      const esriGeom = this.geoJSONToEsriGeometry(geom);\r\n      if (!esriGeom) return;\r\n\r\n      // Add ArcGIS-specific properties directly to StpSymbol object\r\n      stpSymbol.objectid = this.nextObjectId++;\r\n      // Resolve computed deltaSIDC property explicitly otherwise it is not accessible via fieldMap \r\n      // since it is a getter, and DictionaryRenderer requires a direct property for mapping\r\n      stpSymbol.symbolId = stpSymbol.deltaSIDC;\r\n      const addGraphic = (layerRef: any, graphic: any) => {\r\n        layerRef.applyEdits({ addFeatures: [graphic] }).catch((e: any) => console.error('Failed to add feature:', e));\r\n        // Store reference for later removal (using poid as key if available)\r\n        if (stpSymbol.poid) {\r\n          const arr = this.assets.get(stpSymbol.poid) || [];\r\n          arr.push(graphic);\r\n          this.assets.set(stpSymbol.poid, arr);\r\n        }\r\n      };\r\n\r\n      const graphic = new Graphic({ geometry: esriGeom, attributes: stpSymbol });\r\n\r\n      // Handle by geometry type\r\n      if (esriGeom.type === 'point') {\r\n        addGraphic(this.symbolLayerPoint, graphic);\r\n      } else if (esriGeom.type === 'polyline') {\r\n        addGraphic(this.symbolLayerLine, graphic);\r\n      } else if (esriGeom.type === 'polygon') {\r\n        addGraphic(this.symbolLayerPolygon, graphic);\r\n      } else if (esriGeom.type === 'multipoint') {\r\n        addGraphic(this.symbolLayerMultipoint, graphic); \r\n      }\r\n    });\r\n  };\r\n\r\n  removeFeature = async (poid: string) => {\r\n    if (!poid) return;\r\n    try {\r\n      const where = `poid = '${poid.replace(/'/g, \"''\")}'`;\r\n      const layers = [this.symbolLayerPoint, this.symbolLayerMultipoint, this.symbolLayerLine, this.symbolLayerPolygon].filter(Boolean);\r\n      for (const lyr of layers) {\r\n        const q = lyr.createQuery();\r\n        q.where = where;\r\n        const res = await lyr.queryFeatures(q);\r\n        if (res && res.features && res.features.length) {\r\n          await lyr.applyEdits({ deleteFeatures: res.features });\r\n        }\r\n      }\r\n      this.assets.delete(poid);\r\n    } catch (e) {\r\n      console.error('Failed to remove feature:', e);\r\n    }\r\n  };\r\n\r\n  addPoly = (coords: Array<{ lat: number; lon: number }>, color = '#66cc00', weight = 2) => {\r\n    if (!coords || coords.length === 0) return;\r\n    require(['esri/Graphic', 'esri/geometry/Polyline'], (Graphic: any, Polyline: any) => {\r\n      const path = coords.map(c => [c.lon, c.lat]);\r\n      const polyline = new Polyline({ paths: [path], spatialReference: { wkid: 4326 } });\r\n      this.inkLayer.add(new Graphic({ geometry: polyline, symbol: { type: 'simple-line', color, width: weight } }));\r\n    });\r\n  };\r\n\r\n  getBounds = () => this.viewRef?.extent;\r\n\r\n  displayInfo = (\r\n    content: string,\r\n    location: { lat: number; lon: number },\r\n    handlers?: Array<{ selector: string; handler: (e: Event) => void; closeInfo?: boolean }>\r\n  ) => {\r\n    const node = document.createElement('div');\r\n    node.innerHTML = content;\r\n    this.viewRef.popup.open({ content: node, location: { latitude: location.lat, longitude: location.lon } });\r\n    if (handlers && handlers.length) {\r\n      for (let i = 0; i < handlers.length; i++) {\r\n        const instance = node.querySelector(handlers[i].selector);\r\n        if (instance && handlers[i].handler) {\r\n          instance.addEventListener('click', (event: any) => {\r\n            if (handlers[i].closeInfo) this.viewRef.popup.close();\r\n            handlers[i].handler(event);\r\n          });\r\n        }\r\n      }\r\n    }\r\n  };\r\n\r\n  clearInk = () => {\r\n    if (this.inkLayer) {\r\n      this.inkLayer.removeAll();\r\n      console.debug('Ink layer cleared successfully');\r\n    } else {\r\n      console.warn('clearInk called before inkLayer was initialized');\r\n    }\r\n    this.strokeGraphic = undefined;\r\n  };\r\n\r\n  private getIsoTimestamp = () => new Date().toISOString();\r\n\r\n  private geoJSONToEsriGeometry = (geom: any) => {\r\n    if (!geom) return null;\r\n    const sr = { wkid: 4326 };\r\n    switch (geom.type) {\r\n      case 'Point':\r\n        return { type: 'point', longitude: geom.coordinates[0], latitude: geom.coordinates[1], spatialReference: sr };\r\n      case 'MultiPoint':\r\n        return { type: 'multipoint', points: geom.coordinates.map((c: any) => [c[0], c[1]]), spatialReference: sr };\r\n      case 'LineString':\r\n        return { type: 'polyline', paths: [geom.coordinates.map((c: any) => [c[0], c[1]])], spatialReference: sr };\r\n      case 'Polygon':\r\n        return { type: 'polygon', rings: geom.coordinates[0].map((c: any) => [c[0], c[1]]), spatialReference: sr };\r\n      default:\r\n        return null;\r\n    }\r\n  };\r\n\r\n  private convertExtentToWGS84 = (extent: any, Point: any, SpatialReference: any, projection: any) => {\r\n    if (extent.spatialReference.wkid === 4326) {\r\n      return {\r\n        topLeft: { lat: extent.ymax, lon: extent.xmin },\r\n        bottomRight: { lat: extent.ymin, lon: extent.xmax }\r\n      };\r\n    }\r\n    \r\n    try {\r\n      const wgs84SR = new SpatialReference({ wkid: 4326 });\r\n      const topLeftGeo = projection.project(new Point({\r\n        x: extent.xmin, y: extent.ymax, spatialReference: extent.spatialReference\r\n      }), wgs84SR) as any;\r\n      const bottomRightGeo = projection.project(new Point({\r\n        x: extent.xmax, y: extent.ymin, spatialReference: extent.spatialReference\r\n      }), wgs84SR) as any;\r\n      \r\n      return {\r\n        topLeft: { lat: topLeftGeo.y, lon: topLeftGeo.x },\r\n        bottomRight: { lat: bottomRightGeo.y, lon: bottomRightGeo.x }\r\n      };\r\n    } catch (err) {\r\n      console.error('Coordinate projection failed:', err);\r\n      return {\r\n        topLeft: { lat: extent.ymax, lon: extent.xmin },\r\n        bottomRight: { lat: extent.ymin, lon: extent.xmax }\r\n      };\r\n    }\r\n  };\r\n}\r\n\r\n(window as any).ArcGISMap = ArcGISMap;"]}