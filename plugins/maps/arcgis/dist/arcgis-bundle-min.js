var e,t;e=this,t=function(e){class t{constructor(e,t,i,o,n){var s,r;this.drawing=!1,this.strokeStartTs="",this.assets=new Map,this.nextObjectId=1,this.load=async()=>{const e=document.getElementById(this.mapDivId);if(!e)throw new Error(`Html page must contain a '#${this.mapDivId}' div`);return new Promise((t,i)=>{try{require(["esri/Map","esri/views/MapView","esri/layers/FeatureLayer","esri/renderers/DictionaryRenderer","esri/layers/GraphicsLayer","esri/Graphic","esri/geometry/Point","esri/geometry/Multipoint","esri/geometry/Polyline","esri/geometry/Polygon","esri/geometry/projection","esri/geometry/SpatialReference","esri/config"],(i,o,n,s,r,a,l,d,c,p,y,h,m)=>{this.apiKey&&m&&(m.apiKey=this.apiKey);const u=[{name:"objectid",type:"oid"},{name:"symbolId",type:"string"},{name:"poid",type:"string"},{name:"designator1",type:"string"},{name:"parent",type:"string"},{name:"echelon",type:"string"},{name:"status",type:"string"},{name:"affiliation",type:"string"},{name:"modifier",type:"string"},{name:"timeFrom",type:"date"},{name:"timeTo",type:"date"},{name:"minAltitude",type:"double"},{name:"maxAltitude",type:"double"},{name:"description",type:"string"},{name:"fullDescription",type:"string"}];let g;this.milDictionaryStyleUrl?(g=this.milDictionaryStyleUrl,console.info("ArcGISMap: Using MIL-STD-2525 styleUrl:",g)):this.milDictionaryPortalItemId?(g=this.milDictionaryPortalItemId,console.info("ArcGISMap: Using MIL-STD-2525 portalItem ID:",g)):(g="https://www.arcgis.com/sharing/rest/content/items/d815f3bdf6e6452bb8fd153b654c94ca",console.info("ArcGISMap: Using default MIL-STD-2525D full URL:",g));const f=new s({url:g,fieldMap:{sidc:"symbolId",uniquedesignation:"designator1",higherformation:"parent",datetimevalid:"timeFrom",datetimeexpired:"timeTo",z:"minAltitude",z2:"maxAltitude"},config:{model:"ORDERED ANCHOR POINTS"}}),w=new a({geometry:new l({longitude:0,latitude:0,spatialReference:{wkid:4326}}),attributes:{objectid:0}});this.symbolLayerPoint=new n({title:"STP Symbols (Point)",source:[w],fields:u,objectIdField:"objectid",geometryType:"point",spatialReference:{wkid:4326},renderer:f});const b=new a({geometry:new d({points:[[0,0]],spatialReference:{wkid:4326}}),attributes:{objectid:0}});this.symbolLayerMultipoint=new n({title:"STP Symbols (Multipoint)",source:[b],fields:u,objectIdField:"objectid",geometryType:"multipoint",spatialReference:{wkid:4326},renderer:f}),this.symbolLayerLine=new n({title:"STP Symbols (Line)",source:[],fields:u,objectIdField:"objectid",geometryType:"polyline",spatialReference:{wkid:4326},renderer:f}),this.symbolLayerPolygon=new n({title:"STP Symbols (Area)",source:[],fields:u,objectIdField:"objectid",geometryType:"polygon",spatialReference:{wkid:4326},renderer:f}),this.mapRef=new i({basemap:"topo-vector"}),this.viewRef=new o({container:e,map:this.mapRef,center:[this.mapCenter.lon,this.mapCenter.lat],zoom:this.zoomLevel,constraints:{snapToZoom:!1}}),this.viewRef.when(()=>{this.inkLayer=new r({title:"Ink"}),console.debug("InkLayer created:",this.inkLayer),this.mapRef.add(this.inkLayer),console.debug("InkLayer created and added to map"),this.viewRef.whenLayerView(this.inkLayer).then(e=>{this.inkLayerView=e,console.debug("InkLayerView is now ready")}).catch(e=>{console.error("Failed to obtain inkLayerView:",e)});const e=this.viewRef.container;e&&e.style&&(e.style.cursor="crosshair"),y.load(),this.mapRef.addMany([this.symbolLayerPoint,this.symbolLayerMultipoint,this.symbolLayerLine,this.symbolLayerPolygon]),this.viewRef.on("drag",e=>{e.stopPropagation()})}),this.viewRef.on("click",async e=>{var t,i;try{const o=await this.viewRef.hitTest(e),n=null===(i=null===(t=null==o?void 0:o.results)||void 0===t?void 0:t.find(e=>{var t;const i=null===(t=e.graphic)||void 0===t?void 0:t.layer;return i===this.symbolLayerPoint||i===this.symbolLayerLine||i===this.symbolLayerPolygon}))||void 0===i?void 0:i.graphic;n&&this.onSelection&&this.onSelection.call(this,n.attributes)}catch(e){}}),this.viewRef.on("pointer-down",e=>{var t;if(0!==e.button)return;e.stopPropagation(),e.preventDefault(),this.drawing=!0,this.strokeStartTs=this.getIsoTimestamp();const i=this.viewRef.toMap({x:e.x,y:e.y}),o={lat:i.latitude,lon:i.longitude};null===(t=this.onStrokeStart)||void 0===t||t.call(this,o,this.strokeStartTs);const n=new c({paths:[[[i.longitude,i.latitude]]],spatialReference:{wkid:4326}});this.strokeGraphic=new a({geometry:n,symbol:{type:"simple-line",color:"#8B0000",width:2}}),this.inkLayer.add(this.strokeGraphic),console.debug("Stroke started, initial path:",n.paths)}),this.viewRef.on("pointer-move",e=>{if(!this.drawing||!this.strokeGraphic)return;e.stopPropagation();const t=this.viewRef.toMap({x:e.x,y:e.y}),i=[...this.strokeGraphic.geometry.paths||[[]]];i[0]=[...i[0]||[],[t.longitude,t.latitude]];const o=new c({paths:i,spatialReference:{wkid:4326}});this.strokeGraphic.geometry=o,console.debug("Stroke move, path length:",i[0].length)});const v=e=>{var t,i,o,n,s;if(!this.drawing)return;this.drawing=!1;const r=this.getIsoTimestamp(),a=null===(t=this.strokeGraphic)||void 0===t?void 0:t.geometry;let d=[];(null===(o=null===(i=null==a?void 0:a.paths)||void 0===i?void 0:i[0])||void 0===o?void 0:o.length)>0&&(d=a.paths[0].map(e=>({lat:e[1],lon:e[0]}))),1===d.length&&d.push(d[0]);const c=null===(n=this.viewRef)||void 0===n?void 0:n.extent,p=document.getElementById(this.mapDivId),m={width:p.clientWidth,height:p.clientHeight},{topLeft:u,bottomRight:g}=this.convertExtentToWGS84(c,l,h,y);null===(s=this.onStrokeCompleted)||void 0===s||s.call(this,m,u,g,d,this.strokeStartTs,r,[])};this.viewRef.on("pointer-up",v),document.addEventListener("mouseup",v),t()})}catch(e){i(e)}})},this.addFeature=e=>{e&&require(["esri/Graphic","esri/geometry/Multipoint"],(t,i)=>{const o=e.geometry,n=e.properties.symbol,s=this.geoJSONToEsriGeometry(o);if(!s)return;n.objectid=this.nextObjectId++,n.symbolId=n.deltaSIDC;const r=(e,t)=>{if(e.applyEdits({addFeatures:[t]}).catch(e=>console.error("Failed to add feature:",e)),n.poid){const e=this.assets.get(n.poid)||[];e.push(t),this.assets.set(n.poid,e)}},a=new t({geometry:s,attributes:n});"point"===s.type?r(this.symbolLayerPoint,a):"polyline"===s.type?r(this.symbolLayerLine,a):"polygon"===s.type?r(this.symbolLayerPolygon,a):"multipoint"===s.type&&r(this.symbolLayerMultipoint,a)})},this.removeFeature=async e=>{if(e)try{const t=`poid = '${e.replace(/'/g,"''")}'`,i=[this.symbolLayerPoint,this.symbolLayerMultipoint,this.symbolLayerLine,this.symbolLayerPolygon].filter(Boolean);for(const e of i){const i=e.createQuery();i.where=t;const o=await e.queryFeatures(i);o&&o.features&&o.features.length&&await e.applyEdits({deleteFeatures:o.features})}this.assets.delete(e)}catch(e){console.error("Failed to remove feature:",e)}},this.addPoly=(e,t="#66cc00",i=2)=>{e&&0!==e.length&&require(["esri/Graphic","esri/geometry/Polyline"],(o,n)=>{const s=new n({paths:[e.map(e=>[e.lon,e.lat])],spatialReference:{wkid:4326}});this.inkLayer.add(new o({geometry:s,symbol:{type:"simple-line",color:t,width:i}}))})},this.getBounds=()=>{var e;return null===(e=this.viewRef)||void 0===e?void 0:e.extent},this.displayInfo=(e,t,i)=>{const o=document.createElement("div");if(o.innerHTML=e,this.viewRef.popup.open({content:o,location:{latitude:t.lat,longitude:t.lon}}),i&&i.length)for(let e=0;e<i.length;e++){const t=o.querySelector(i[e].selector);t&&i[e].handler&&t.addEventListener("click",t=>{i[e].closeInfo&&this.viewRef.popup.close(),i[e].handler(t)})}},this.clearInk=()=>{this.inkLayer?(this.inkLayer.removeAll(),console.debug("Ink layer cleared successfully")):console.warn("clearInk called before inkLayer was initialized"),this.strokeGraphic=void 0},this.getIsoTimestamp=()=>(new Date).toISOString(),this.geoJSONToEsriGeometry=e=>{if(!e)return null;const t={wkid:4326};switch(e.type){case"Point":return{type:"point",longitude:e.coordinates[0],latitude:e.coordinates[1],spatialReference:t};case"MultiPoint":return{type:"multipoint",points:e.coordinates.map(e=>[e[0],e[1]]),spatialReference:t};case"LineString":return{type:"polyline",paths:[e.coordinates.map(e=>[e[0],e[1]])],spatialReference:t};case"Polygon":return{type:"polygon",rings:e.coordinates[0].map(e=>[e[0],e[1]]),spatialReference:t};default:return null}},this.convertExtentToWGS84=(e,t,i,o)=>{if(4326===e.spatialReference.wkid)return{topLeft:{lat:e.ymax,lon:e.xmin},bottomRight:{lat:e.ymin,lon:e.xmax}};try{const n=new i({wkid:4326}),s=o.project(new t({x:e.xmin,y:e.ymax,spatialReference:e.spatialReference}),n),r=o.project(new t({x:e.xmax,y:e.ymin,spatialReference:e.spatialReference}),n);return{topLeft:{lat:s.y,lon:s.x},bottomRight:{lat:r.y,lon:r.x}}}catch(t){return console.error("Coordinate projection failed:",t),{topLeft:{lat:e.ymax,lon:e.xmin},bottomRight:{lat:e.ymin,lon:e.xmax}}}},this.apiKey=null!=e?e:null,this.mapDivId=t,this.mapCenter=i,this.zoomLevel=o,this.milDictionaryStyleUrl=null!==(s=null==n?void 0:n.mil2525StyleUrl)&&void 0!==s?s:null,this.milDictionaryPortalItemId=null!==(r=null==n?void 0:n.mil2525PortalItemId)&&void 0!==r?r:null}}window.ArcGISMap=t,e.ArcGISMap=t},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).ArcGISMap={});