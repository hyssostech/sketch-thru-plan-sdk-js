!function(t){function e(t){var e=Object.create(null);return t&&Object.keys(t).forEach(function(o){if("default"!==o){var i=Object.getOwnPropertyDescriptor(t,o);Object.defineProperty(e,o,i.get?i:{enumerable:!0,get:function(){return t[o]}})}}),e.default=t,Object.freeze(e)}var o,i,s,n,r,a,c,l=e(t);function d(t,e){let o,i=t&&t.type;if("FeatureCollection"===i){let i=t;for(o=0;o<i.features.length;o++)d(i.features[o],e)}else if("GeometryCollection"===i){let i=t;for(o=0;o<i.geometries.length;o++)d(i.geometries[o],e)}else if("Feature"===i){d(t.geometry,e)}else if("Polygon"===i){h(t.coordinates,e)}else if("MultiPolygon"===i){let i=t;for(o=0;o<i.coordinates.length;o++)h(i.coordinates[o],e)}return t}function h(t,e){if(0!==t.length){p(t[0],e);for(let o=1;o<t.length;o++)p(t[o],!e)}}function p(t,e){let o=0;for(let e=0,i=t.length,s=i-1;e<i;s=e++)o+=(t[e][0]-t[s][0])*(t[s][1]+t[e][1]);o>=0!=!!e&&t.reverse()}!function(t){t.Error="Error",t.Warning="Warning",t.Info="Info",t.Debug="Debug"}(o||(o={})),function(t){t.s2="S2",t.s3="S3",t.s4="S4",t.fso="FSO",t.eng="ENG"}(i||(i={}));class u{}class m extends u{asGeoJSON(){if(null==this.location||null==this.location.coords||0==this.location?.coords.length)throw new Error("Coordinates are undefined or empty");let t;if("point"===this.location?.fsTYPE)t={type:"Point",coordinates:[this.location.coords[0].lon,this.location.coords[0].lat]};else if("line"===this.location?.fsTYPE)t={type:"LineString",coordinates:this.location.coords.map(t=>[t.lon,t.lat])};else if("area"===this.location?.fsTYPE)t={type:"Polygon",coordinates:[this.location.coords.map(t=>[t.lon,t.lat])]},t=d(t,!1);else{if("multipoint"!==this.location?.fsTYPE)throw new Error('Expected "point", "line", "area", or "multipoint" geometry type. Got: '+this.location?.fsTYPE);t={type:"MultiPoint",coordinates:this.location.coords.map(t=>[t.lon,t.lat])}}return{type:"Feature",id:this.poid,geometry:t,properties:{symbol:this}}}}class g{}class f extends m{}class S{}!function(t){t.None="none",t.Organic="organic",t.Attached="attached",t.Assigned="assigned",t.AdCon="adcon",t.OpCon="opcon",t.TaCon="tacon",t.DirectSupport="ds",t.Reinforcing="r",t.GeneralSupportReinforcing="gsr",t.GeneralSupport="gs"}(s||(s={}));class y extends u{}class k{}!function(t){t.NotSpecified="not_specified",t.AdvisePolice="advise_police",t.Ambush="ambush",t.AssignResponsibility="assign_responsibility",t.Block="block",t.BombAttack="bomb_attack",t.Breach="breach",t.Bypass="bypass",t.Clear="clear",t.CoerciveRecruiting="coercive_recruiting",t.CollectCasualties="collect_casualties",t.CollectCivilians="collect_civilians",t.CollectPrisoners="collect_prisoners",t.ConductAmbush="conduct_ambush",t.ConductAviatonAmbush="conduct_aviaton_ambush",t.ConductBilat="conduct_bilat",t.ConductGroupEngagement="conduct_group_engagement",t.ConductRaid="conduct_raid",t.ConductTcpOperation="conduct_tcp_operation",t.ConstituteReserve="constitute_reserve",t.Convoy="convoy",t.Defeat="defeat",t.Delay="delay",t.DeliverLeafletPsyop="deliver_leaflet_psyop",t.Demonstrate="demonstrate",t.Destroy="destroy",t.Disrupt="disrupt",t.DistributeFood="distribute_food",t.Emplace="emplace",t.EquipPolice="equip_police",t.EscortConvoy="escort_convoy",t.EvacuateCasualties="evacuate_casualties",t.EvacuateCivilians="evacuate_civilians",t.EvacuatePrisoners="evacuate_prisoners",t.Fix="fix",t.Follow="follow",t.FollowAndAssume="follow_and_assume",t.FollowAndSupport="follow_and_support",t.Halt="halt",t.HarrassmentFires="harrassment_fires",t.HouseToHousePsyop="house_to_house_psyop",t.IedAttack="ied_attack",t.Limit="limit",t.Looting="looting",t.MaintainHide="maintain_hide",t.MaintainOutpost="maintain_outpost",t.Move="move",t.Neutralize="neutralize",t.Observe="observe",t.Occupy="occupy",t.Patrol="patrol",t.Penetrate="penetrate",t.PositionSniper="position_sniper",t.PriorityOfFires="priority_of_fires",t.ProvideMedicalServices="provide_medical_services",t.ProvideService="provide_service",t.Receive="receive",t.Reconstruction="reconstruction",t.RecruitPolice="recruit_police",t.Refuel="refuel",t.RegulateTraffic="regulate_traffic",t.Reinforce="reinforce",t.Release="release",t.Resupply="resupply",t.Retain="retain",t.Rioting="rioting",t.Secure="secure",t.SeekRefuge="seek_refuge",t.Seize="seize",t.SniperAttack="sniper_attack",t.Supply="supply",t.SupplyMunitions="supply_munitions",t.TrainPolice="train_police",t.TransferMunitions="transfer_munitions",t.TrashRemoval="trash_removal",t.Turn="turn",t.TvRadioPsyop="tv_radio_psyop",t.WaterDelivery="water_delivery",t.WillfulRecruiting="willful_recruiting"}(n||(n={})),function(t){t.NotSpecified="not_specified",t.AirAssault="air_assault",t.AirReconnaissance="air_reconnaissance",t.AreaDefense="area_defense",t.Assault="assault",t.Attack="attack",t.AttackInZone="attack_in_zone",t.AttackByFire="attack_by_fire",t.CerpFunding="cerp_funding",t.Civilian="civilian",t.Contracting="contracting",t.CordonAndSearch="cordon_and_search",t.Counterattack="counterattack",t.CounterattackByFire="counterattack_by_fire",t.Cover="cover",t.Defend="defend",t.DeliverServices="deliver_services",t.Guard="guard",t.InformationOperations="information_operations",t.Insurgent="insurgent",t.MobileDefense="mobile_defense",t.MovingScreen="moving_screen",t.NgoOperation="ngo_operation",t.PassageOfLines="passage_of_lines",t.Screen="screen",t.SearchAndAttack="search_and_attack",t.Security="security",t.SecurityForceAssistance="security_force_assistance",t.SupportByFire="support_by_fire",t.Withdrawal="withdrawal"}(r||(r={})),function(t){t.Unknown="unknown",t.Allow="allow",t.Cause="cause",t.Create="create",t.Deceive="deceive",t.Deny="deny",t.Divert="divert",t.Enable="enable",t.Envelop="envelop",t.Influence="influence",t.Open="open",t.Prevent="prevent",t.Protect="protect",t.Support="support",t.Surprise="surprise"}(a||(a={})),function(t){t.NotSpecified="not_specified",t.Hold="hold",t.Tight="tight",t.Free="free"}(c||(c={}));class T{constructor(t,e){this.lat=t,this.lon=e}equals(t){return this.lat==t.lat&&this.lon==t.lon}}class w{constructor(t,e){this.width=t,this.height=e}equals(t){return this.width==t.width&&this.height==t.height}}class C{constructor(t,e){this.stpsdk=t,this.options=e,t.onSymbolReport=(t,e)=>{this.onSymbolReport&&this.onSymbolReport(t,e)}}async exportPlanDataToC2SIMServer(t,e,o,i,s){let n=await this.getC2SIMContent(t,e,o,i,s);n&&await this.pushC2SIMContent(n,e,s)}async importInitializationFromC2SIMServer(t){let e=await this.pullC2SIMInitialization(t),o=await this.convertC2SIMContent(e,t);await this.stpsdk.syncScenarioSession(o,t)}async getC2SIMContent(t,e,o,i,s){return this.stpsdk.requestStp("GetC2SIMContent",{name:arguments[0],dataType:arguments[1],affiliation:arguments[2],coaPoids:arguments[3],options:this.options},s)}async pushC2SIMContent(t,e,o){return this.stpsdk.requestStp("PushC2SIMContent",{content:arguments[0],dataType:arguments[1],options:this.options},o)}async pullC2SIMInitialization(t){return this.stpsdk.requestStp("PullC2SIMInitialization",{options:this.options},t)}async convertC2SIMContent(t,e){return this.stpsdk.requestStp("ConvertC2SIMContent",{content:arguments[0],options:this.options},e)}}class b{constructor(t){this.stpConnector=t,this.serviceName=""}async connect(t,e,o,i){this.serviceName=t,this.stpConnector.onInform=this.onInform.bind(this),this.stpConnector.onRequest=this.onRequest.bind(this),this.stpConnector.onError=this.onError.bind(this);try{let t=this.buildSolvables();return this.stpConnector.connect(this.serviceName,t,e,o,i)}catch(t){throw t}}buildSolvables(){return Object.getOwnPropertyNames(this).filter(t=>t.toString().startsWith("on")&&"function"==typeof this[t]).map(t=>t.substring(2))}onInform(t){let e=JSON.parse(t);this.handleInform(e)}onRequest(t){return this.onInform(t),[]}onError(t){this.onStpMessage&&this.onStpMessage(t,o.Error)}handleInform(t){if("SymbolAdded"===t.method&&this.onSymbolAdded){const e=t.params;let o=[];for(let t=0;t<e.alternates.length;t++){const i=Object.assign(new m,e.alternates[t]);o.push(i)}this.onSymbolAdded(o,e.isUndo)}else if("SymbolModified"===t.method&&this.onSymbolModified){const e=t.params,o=Object.assign(new m,e.symbol);this.onSymbolModified(e.poid,o,e.isUndo)}else if("SymbolDeleted"===t.method&&this.onSymbolDeleted){const e=t.params;this.onSymbolDeleted(e.poid,e.isUndo)}else if("SymbolReport"===t.method&&this.onSymbolReport){const e=t.params,o=Object.assign(new m,e.symbol);this.onSymbolReport(e.poid,o)}else if("TaskOrgAdded"===t.method&&this.onTaskOrgAdded||"TaskOrgModified"===t.method&&this.onTaskOrgModified){const e=t.params,o=Object.assign(new g,e.taskOrg);"TaskOrgAdded"===t.method&&this.onTaskOrgAdded?this.onTaskOrgAdded(o,e.isUndo):"TaskOrgModified"===t.method&&this.onTaskOrgModified&&this.onTaskOrgModified(e.poid,o,e.isUndo)}else if("TaskOrgDeleted"===t.method&&this.onTaskOrgDeleted){const e=t.params;this.onTaskOrgDeleted(e.poid,e.isUndo)}else if("TaskOrgUnitAdded"===t.method&&this.onTaskOrgUnitAdded||"TaskOrgUnitModified"===t.method&&this.onTaskOrgUnitModified){const e=t.params,o=Object.assign(new f,e.toUnit);"TaskOrgUnitAdded"===t.method&&this.onTaskOrgUnitAdded?this.onTaskOrgUnitAdded(o,e.isUndo):"TaskOrgUnitModified"===t.method&&this.onTaskOrgUnitModified&&this.onTaskOrgUnitModified(e.poid,o,e.isUndo)}else if("TaskOrgUnitDeleted"===t.method&&this.onTaskOrgUnitDeleted){const e=t.params;this.onTaskOrgUnitDeleted(e.poid,e.isUndo)}else if("TaskOrgRelationshipAdded"===t.method&&this.onTaskOrgRelationshipAdded||"TaskOrgRelationshipModified"===t.method&&this.onTaskOrgRelationshipModified){const e=t.params,o=Object.assign(new S,e.toRelationship);"TaskOrgRelationshipAdded"===t.method&&this.onTaskOrgRelationshipAdded?this.onTaskOrgRelationshipAdded(o,e.isUndo):"TaskOrgRelationshipModified"===t.method&&this.onTaskOrgRelationshipModified&&this.onTaskOrgRelationshipModified(e.poid,o,e.isUndo)}else if("TaskOrgRelationshipDeleted"===t.method&&this.onTaskOrgRelationshipDeleted){const e=t.params;this.onTaskOrgRelationshipDeleted(e.poid,e.isUndo)}else if("TaskAdded"===t.method&&this.onTaskAdded||"TaskModified"===t.method&&this.onTaskModified){const e=t.params;let o=[];for(let t=0;t<e.alternates.length;t++){const i=Object.assign(new y,e.alternates[t]);o.push(i)}"TaskAdded"===t.method&&this.onTaskAdded?this.onTaskAdded(e.poid,o,e.taskPoids,e.isUndo):"TaskModified"===t.method&&this.onTaskModified&&this.onTaskModified(e.poid,o,e.taskPoids,e.isUndo)}else if("TaskDeleted"===t.method&&this.onTaskDeleted){const e=t.params;this.onTaskDeleted(e.poid,e.isUndo)}else if("TaskOrgSwitched"===t.method&&this.onTaskOrgSwitched){const e=t.params;this.onTaskOrgSwitched(e.taskOrg)}else if("CoaAdded"===t.method&&this.onCoaAdded||"CoaModified"===t.method&&this.onCoaModified){const e=t.params,o=Object.assign(new k,e.coa);"CoaAdded"===t.method&&this.onCoaAdded?this.onCoaAdded(e.poid,e.coa,e.isUndo):"CoaModified"===t.method&&this.onCoaModified&&this.onCoaModified(e.poid,o,e.isUndo)}else if("CoaDeleted"===t.method&&this.onCoaDeleted){const e=t.params;this.onCoaDeleted(e.poid,e.isUndo)}else if("RoleSwitched"===t.method&&this.onRoleSwitched){const e=t.params;this.onRoleSwitched(e.role)}else if("InkProcessed"===t.method&&this.onInkProcessed)this.onInkProcessed();else if("SpeechRecognized"===t.method&&this.onSpeechRecognized){const e=t.params;this.onSpeechRecognized(e.phrases)}else if("SymbolEdited"===t.method&&this.onSymbolEdited){const e=t.params;this.onSymbolEdited(e.operation,e.location)}else if("MapOperation"===t.method&&this.onMapOperation){const e=t.params;this.onMapOperation(e.operation,e.location)}else if("Command"===t.method&&this.onCommand){const e=t.params;this.onCommand(e.operation,e.location)}else if("StpMessage"===t.method&&this.onStpMessage){const e=t.params;this.onStpMessage(e.message,e.level)}else console.log("Received message with no handler: "+t.method)}informStp(t,e){try{let o={method:t,params:e};this.stpConnector.inform(JSON.stringify(o))}catch(t){this.onStpMessage&&this.onStpMessage(t.message,o.Error)}}async requestStp(t,e,i){try{let o={method:t,params:e};return this.stpConnector.request(JSON.stringify(o),i)}catch(t){this.onStpMessage&&this.onStpMessage(t.message,o.Error)}}sendPenDown(t,e){this.informStp("SendPenDown",{location:arguments[0],timestamp:arguments[1]})}sendInk(t,e,o,i,s,n,r){this.informStp("SendInk",{pixelBoundsWindow:arguments[0],topLeftGeoMap:arguments[1],bottomRightGeoMap:arguments[2],strokePoints:arguments[3],timeStrokeStart:arguments[4],timeStrokeEnd:arguments[5],intersectedPoids:arguments[6]})}sendSpeechRecognition(t,e,o){this.informStp("SendSpeechRecognition",{recoList:arguments[0],startTime:arguments[1],endTime:arguments[2]})}async createNewScenario(t,e){return this.requestStp("CreateNewScenario",{name:arguments[0]},e)}async loadNewScenario(t,e){return this.requestStp("LoadNewScenario",{content:arguments[0]},e)}async importPlanData(t,e){return this.requestStp("ImportPlanData",{content:arguments[0]},e)}async getScenarioContent(t){return this.requestStp("GetScenarioContent",null,t)}async joinScenarioSession(t){return this.requestStp("JoinScenarioSession",null,t)}async syncScenarioSession(t,e){return this.requestStp("SyncScenarioSession",{content:arguments[0]},e)}async hasActiveScenario(t){return this.requestStp("HasActiveScenario",null,t)}createC2SIMProxy(t){return new C(this,t)}addSymbol(t){this.informStp("AddSymbol",{symbol:arguments[0]})}updateSymbol(t,e){this.informStp("UpdateSymbol",{poid:arguments[0],symbol:arguments[1]})}deleteSymbol(t){this.informStp("DeleteSymbol",{poid:arguments[0]})}chooseAlternate(t,e){this.informStp("ChooseAlternate",{poid:arguments[0],nBestIndex:arguments[1]})}async importTaskOrgContent(t,e){return this.requestStp("ImportTaskOrgContent",{content:arguments[0]},e)}async getTaskOrgContent(t,e){return this.requestStp("GetTaskOrgContent",{poid:arguments[0]},e)}async setDefaultTaskOrg(t,e){return this.requestStp("SetDefaultTaskOrg",{poid:arguments[0]},e)}async resetDefaultTaskOrg(t,e){return this.requestStp("ResetDefaultTaskOrg",{affiliation:arguments[0]},e)}addTaskOrg(t){this.informStp("AddTaskOrg",{taskOrg:arguments[0]})}updateTaskOrg(t,e){this.informStp("UpdateTaskOrg",{poid:arguments[0],taskOrg:arguments[1]})}deleteTaskOrg(t){this.informStp("DeleteTaskOrg",{poid:arguments[0]})}addTaskOrgUnit(t){this.informStp("AddTaskOrgUnit",{toUnit:arguments[0]})}updateTaskOrgUnit(t,e){this.informStp("UpdateTaskOrgUnit",{poid:arguments[0],toUnit:arguments[1]})}deleteTaskOrgUnit(t){this.informStp("DeleteTaskOrgUnit",{poid:arguments[0]})}addTaskOrgRelationship(t){this.informStp("AddTaskOrgRelationship",{toRelationship:arguments[0]})}updateTaskOrgRelationship(t,e){this.informStp("UpdateTaskOrgRelationship",{poid:arguments[0],toRelationship:arguments[1]})}deleteTaskOrgRelationship(t){this.informStp("DeleteTaskOrgRelationship",{poid:arguments[0]})}addTask(t){this.informStp("AddTask",{task:arguments[0]})}updateTask(t,e){this.informStp("UpdateTask",{poid:arguments[0],alternates:arguments[1]})}deleteTask(t){this.informStp("DeleteTask",{poid:arguments[0]})}confirmTask(t,e,o=!0){this.informStp("ConfirmTask",{poid:arguments[0],nBestIndex:arguments[1],isConfirmed:arguments[2]})}async setCoaTaskOrg(t,e,o){return this.requestStp("SetCoaTaskOrg",{toPoid:arguments[0],coaPoid:arguments[1]},o)}async resetCoaTaskOrg(t,e){return this.requestStp("SetCoaTaskOrg",{affiliation:arguments[0],coaPoid:arguments[1]},e)}async importCoaContent(t,e){return this.requestStp("ImportCoaContent",{content:arguments[0]},e)}async getCoaContent(t,e){return this.requestStp("GetCoaContent",{poid:arguments[0]},e)}async setCurrentCoa(t,e){return this.requestStp("SetCurrentCoa",{poid:arguments[0]},e)}addCoa(t){this.informStp("AddCoa",{coa:arguments[0]})}updateCoa(t,e){this.informStp("UpdateCoa",{poid:arguments[0],coa:arguments[1]})}deleteCoa(t){this.informStp("DeleteCoa",{poid:arguments[0]})}async setCurrentRole(t,e=!0,o){return this.requestStp("SetRole",{role:arguments[0]},o)}promiseWithTimeout(t,e){return Promise.race([e,new Promise((e,o)=>{let i=setTimeout(()=>{clearTimeout(i),o(new Error("Operation timed out"))},1e3*t)})])}}class O{get isConnected(){return null!=this.socket&&this.socket.readyState===this.socket.OPEN}get isConnecting(){return null!=this.socket&&this.socket.readyState===this.socket.CONNECTING}get connState(){return this.socket?this.socket.readyState.toString():""}constructor(t){this.DEFAULT_TIMEOUT=30,this.connstring=t,this.socket=null}async connect(t,e,o=this.DEFAULT_TIMEOUT,i=null,s=null){return new Promise(async(n,r)=>{this.isConnected&&n(this.sessionId),this.serviceName=t,this.solvables=e,null!=i&&(this.machineId=i),null!=s&&(this.sessionId=s),o<=0&&(o=this.DEFAULT_TIMEOUT);try{this.socket=await this.promiseWithTimeout(o,this.tryConnect(this.connstring))}catch(t){return void r(new Error("Failed to connect: "+t.message))}this.socket.onmessage=t=>{const e=JSON.parse(t.data);if("RequestResponse"===e.method){const t=e.params;let o=v.trackedResponses.findIndex(e=>e.cookie===t.cookie);if(v.trackedResponses.find(e=>e.cookie===t.cookie),o>-1){let e=v.trackedResponses.splice(o,1)[0];t.success?e.responseFuture.resolve(t.result):e.responseFuture.reject(t.result)}}else this.onInform&&this.onInform(t.data)},this.socket.onerror=t=>{this.onError&&this.onError("Error connecting to STP. Check that the service is running and refresh page to retry")},this.socket.onclose=async t=>{if(!this.isConnecting)try{await this.connect(this.serviceName,this.solvables,this.timeout,this.machineId)}catch(t){this.onError&&this.onError("Lost connection to STP. Check that the service is running and refresh page to retry")}};try{this.sessionId=await this.register(o)}catch(t){return void r(new Error("Failed to register with STP: "+t.message))}n(this.sessionId)})}register(t=this.DEFAULT_TIMEOUT){if(!this.isConnected)throw new Error("Failed to register: connection is not open ("+this.connState+")");this.name=this.serviceName;let e={method:"Register",params:{serviceName:this.serviceName,language:"javascript",solvables:this.solvables,machineId:this.machineId||this.getUniqueId(9),sessionId:this.sessionId}};return this.request(JSON.stringify(e),t)}disconnect(t=this.DEFAULT_TIMEOUT){return this.promiseWithTimeout(t,new Promise(async(t,e)=>{!this.isConnected&&this.socket&&this.socket.close(),t()}))}inform(t,e=this.DEFAULT_TIMEOUT){if(!this.isConnected)throw new Error("Failed to send inform: connection is not open ("+this.connState+")");return this.promiseWithTimeout(e,new Promise(async(e,o)=>{this.socket&&(this.socket.send(t),e())}))}async request(t,e=this.DEFAULT_TIMEOUT){if(!this.isConnected||!this.socket)throw new Error("Failed to send request: connection is not open ("+this.connState+")");let o=new v;return this.promiseWithTimeout(e,new Promise(async(i,s)=>{if(!this.socket)return;const n={method:"Request",params:{jsonRequest:t,cookie:o.cookie,timeout:e}};this.socket.send(JSON.stringify(n)),o.responseFuture.then(t=>i(t)).catch(t=>s(t))}))}tryConnect(t){return new Promise((e,o)=>{var i=new WebSocket(t);i.onopen=()=>e(i),i.onerror=t=>o(new Error("Unspecified error communicating with STP"))})}promiseWithTimeout(t,e){return Promise.race([e,new Promise((e,o)=>{let i=setTimeout(()=>{clearTimeout(i),o(new Error("Operation timed out"))},1e3*t)})])}getUniqueId(t){return t||(t=9),Math.random().toString(36).substr(2,t)}}class v{constructor(){this.cookie=v.lastCookie++,this.responseFuture=new R,v.trackedResponses.push(this)}}v.lastCookie=0,v.trackedResponses=[];class R{constructor(t){if(!(this instanceof R))return new R(t);this.promise=t||new Promise(this.promiseExecutor.bind(this))}asPromise(){return this.promise}then(t,e){return new R(this.promise.then(t,e))}catch(t){return new R(this.promise.catch(t))}resolve(t){this.resolveFunction(t)}reject(t){this.rejectFunction(t)}promiseExecutor(t,e){this.resolveFunction=t,this.rejectFunction=e}}class P{constructor(t,e,o,i,s){this.speechSubscriptionKey=t,this.serviceRegion=e,this.speechConfig=l.SpeechConfig.fromSubscription(this.speechSubscriptionKey,this.serviceRegion),this.speechConfig.speechRecognitionLanguage=s||"en-US",this.speechConfig.outputFormat=l.OutputFormat.Detailed,o&&(this.speechConfig.endpointId=o),this.audioConfig=i||l.AudioConfig.fromDefaultMicrophoneInput(),this.isListening=!1}setPhraseList(t){this.phraseList=t}initializeReco(){if(this.recognizer=new l.SpeechRecognizer(this.speechConfig,this.audioConfig),this.phraseList){l.PhraseListGrammar.fromRecognizer(this.recognizer).addPhrases(this.phraseList)}}recognizeOnce(t){return t||(t=8),this.initializeReco(),new Promise(async(e,o)=>{for(let o=0;o<t;o++){this.recoStart=new Date;try{return void e(await this.tryReco(this.recoStart))}catch(t){}o<t-1&&await new Promise(t=>setTimeout(t,250))}let i=new Error("Failed to recognize speech");this.onError?.call(this,i),o(i)})}tryReco(t){return new Promise((e,o)=>{this.recognizer.recognizing=(t,e)=>{this.onRecognizing?.call(this,e.result.text)},this.recognizer.recognized=(o,i)=>{let s=this.convertResults(t,i.result);this.onRecognized?.call(this,s),e(s)},this.recognizer.canceled=(t,e)=>{this.isListening=!1,o(new Error(l.CancellationReason[e.reason]))},this.isListening||(this.isListening=!0,this.recognizer?.recognizeOnceAsync(),this.isListening=!1)})}startRecognizing(){this.isListening||(this.initializeReco(),this.recoStart=new Date,this.recognizer.recognizing=(t,e)=>{this.onRecognizing?.call(this,e.result.text)},this.recognizer.recognized=(t,e)=>{let o=this.convertResults(this.recoStart,e.result);this.onRecognized?.call(this,o)},this.recognizer.canceled=(t,e)=>{this.isListening=!1;let o=new Error(l.CancellationReason[e.reason]);this.onError?this.onError.call(this,o):this.onRecognized?.call(this,null)},this.isListening=!0,this.recognizer.startContinuousRecognitionAsync())}stopRecognizing(t){this.recognizer&&setTimeout(()=>{this.recognizer?.close(),this.recognizer=void 0},t||0),this.isListening=!1}convertResults(t,e){if(e.reason===l.ResultReason.NoMatch)return null;let o=new M;o.startTime=this.addTicksToDate(t,e.offset),o.endTime=this.addTicksToDate(o.startTime,e.duration);let i=e.properties.getProperty(l.PropertyId.SpeechServiceResponse_JsonResult);const s=Object.assign(new D,JSON.parse(i)).NBest.map(t=>new A(t.Lexical,t.Confidence));let n=Array.from(s);for(let t=0;t<s.length;t++){const e=s[t];if(e.text.search(/^([a-zA-Z]\s)+[a-zA-Z]$/)>=0){const t=e.text.replace(/\s/g,""),o=.9*e.confidence;n.push(new A(t,o))}else if(e.text.search(/^([a-zA-Z]\s)+[a-zA-Z][a-zA-Z]+$/)>=0){let t=e.text.match(/^(([a-zA-Z]\s)+)([a-zA-Z][a-zA-Z]+)$/);if(t&&4==t.length){const o=t[1].replace(/\s/g,""),i=t[3],s=.85*e.confidence;n.push(new A(o+" "+i,s))}}}return o.results=n.sort((t,e)=>e.confidence-t.confidence),o}addTicksToDate(t,e){let o=1e4*t.getTime()+621355968e9;return new Date((o+e-621355968e9)/1e4)}}class M{constructor(){this.results=[],this.startTime=new Date,this.endTime=new Date}}class A{constructor(t,e){this.text=t,this.confidence=e}}class D{constructor(){this.RecognitionStatus="",this.Offset=0,this.Duration=0,this.DisplayText="",this.NBest=[]}}class E{constructor(t,e=50){this.symbol=t,this.size=e}asGeoJSON(){let t=this.symbol.asGeoJSON(),e=this.getGestureGeometry(this.symbol);t.geometry=e;let o=this.asSVG();return o&&(t.properties.rendering=o),t}asSVG(){if("point"==this.symbol.location?.fsTYPE){return[this.pointSVG(this.symbol)]}return null}getGestureGeometry(t){if(null==t.location||null==t.location||null==t.location.coords||0==t.location.coords.length||null==t.location.centroid)throw new Error("Symbol does not have location information");let e;if("point"==t.location.shape)e={type:"Point",coordinates:[t.location.centroid.lon,t.location.centroid.lat]};else if(e=this.toLineString(t.location.coords),null!=t.location?.shape&&t.location?.shape.includes("arrowfat")){let o=t.location.coords.slice(0,t.location.coords.length-1).reverse();o.push(t.location.coords[t.location.coords.length-1]),e=this.toLineString(o)}else if("ubend"==t.location?.shape){let o=[t.location.coords[0],t.location.coords[2],t.location.coords[3],t.location.coords[1]];e=this.toLineString(o)}else if("ubendthreepoints"==t.location?.shape){let o=new T(t.location.coords[1].lat,t.location.coords[2].lon),i=[t.location.coords[0],t.location.coords[2],o,t.location.coords[1]];e=this.toLineString(i)}else if("vee"==t.location?.shape){let o=[t.location.coords[1],t.location.coords[0],t.location.coords[2]];e=this.toLineString(o)}else"opencircle"==t.location?.shape||"multipoint"==t.location?.shape&&(e={type:"MultiPoint",coordinates:t.location.coords.map(t=>[t.lon,t.lat])});return e}pointSVG(t){if(null==t.location||null==t.location||null==t.location.centroid)throw new Error("Point symbol does not have a defined centroid");let e,o,i,s,n,r=0,a="";const c=1.42;if("friend"===t.affiliation)s=this.size-2,n=this.size/c-2,e="rect",o='width="'+s+'" height="'+n+'" ',i="#80e0ff";else if("hostile"===t.affiliation){let t=this.size/c-2;s=n=t*Math.SQRT2,e="rect",o='width="'+t+'" height="'+t+'" ',i="#ff8080",r=45,a='transform="translate('+s/2+" 0) rotate("+r+')" '}else"neutral"===t.affiliation?(s=n=this.size/c-2,e="rect",o='width="'+s+'" height="'+n+'" ',i="#aaffaa"):(s=n=this.size/c-2,e="circle",o='cx="'+s/2+'" cy="'+n/2+'" r="'+s/2+'" ',i="#ffff80");let l,d='<svg xmlns="http://www.w3.org/2000/svg" version="1.2" baseProfile="tiny" width="'+s+'" height="'+n+'" viewBox="0 0 '+s+" "+n+'" > <'+e+" "+o+' stroke="black" stoke-width="1" fill="'+i+'" '+a+"/></svg>";if(r>0){const t=this.getTransform(d,e);l=[this.applyTransform(t,{x:0,y:0}),this.applyTransform(t,{x:s,y:0}),this.applyTransform(t,{x:s,y:n}),this.applyTransform(t,{x:0,y:n})]}else l=[{x:0,y:0},{x:s,y:0},{x:s,y:n},{x:0,y:n}];return{type:"icon",title:t.description,topLeft:t.location.centroid,bottomRight:t.location.centroid,position:t.location.centroid,svg:btoa(d),shape:l,anchor:{x:s/2,y:n/2}}}getTransform(t,e){let o=document.createElement("div");document.body.appendChild(o),o.setAttribute("style","position:absolute; padding:0; margin:0;visibility:hidden; width:0; height:0"),o.insertAdjacentHTML("beforeend",t);let i=o.querySelector(e),s=i?.getCTM();return document.body.removeChild(o),s?[s.a,s.b,s.c,s.d,s.e,s.f]:[1,0,0,1,0,0]}toLineString(t){return{type:"LineString",coordinates:t.map(t=>[t.lon,t.lat])}}applyTransform(t,e){return{x:e.x*t[0]+e.y*t[2]+t[4],y:e.x*t[1]+e.y*t[3]+t[5]}}}class I{constructor(t,e,o,i){this.strokeStart="",this.strokeEnd="",this.strokePoly=null,this.featureLayers=new Map,this.load=async()=>{await this.initMap()},this.apiKey=t,this.mapDivId=e,this.mapCenter=o,this.zoomLevel=i}async initMap(){const t=document.getElementById(this.mapDivId);if(!t)throw new Error("Html page must contain a 'map' div");this.map=L.map(t).setView([this.mapCenter.lat,this.mapCenter.lon],this.zoomLevel),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(this.map),this.map.getContainer().style.cursor="crosshair";const e=document.createElement("style");e.textContent=".leaflet-container, .leaflet-interactive { cursor: crosshair !important; }",document.head.appendChild(e),this.geoJsonLayer=L.geoJSON(null,{onEachFeature:(t,e)=>{const o=t.id||t.properties&&t.properties.poid;o&&this.featureLayers.set(o,e),e.on("click",()=>{const e=t.properties&&t.properties.symbol||t.symbol;e&&this.onSelection?.call(this,e)})}}).addTo(this.map),this.map.on("mousedown",t=>{const e=t.originalEvent;if(e&&e.ctrlKey)return!1;e&&e.preventDefault(),this.enableDrawing();const o=t.latlng;this.onStrokeStart?.call(this,new T(o.lat,o.lng),this.getIsoTimestamp()),this.drawFreeHand(o)})}drawFreeHand(t){this.strokeStart=this.getIsoTimestamp(),this.clearInk(),this.strokePoly=L.polyline([],{color:"#8B0000",weight:2}).addTo(this.map),this.strokePoly.addLatLng(t);const e=t=>{this.strokePoly.addLatLng(t.latlng)},o=()=>{this.strokeEnd=this.getIsoTimestamp(),this.disableDrawing(),this.map.off("mousemove",e),this.map.off("mouseup",o);const t=this.strokePoly.getLatLngs();1===t.length&&t.push(t[0]);const i=t.map(t=>new T(t.lat,t.lng)),s={width:document.getElementById("map").clientWidth,height:document.getElementById("map").clientHeight},n=this.map.getBounds();this.onStrokeCompleted?.call(this,new w(s.width,s.height),new T(n.getNorthEast().lat,n.getSouthWest().lng),new T(n.getSouthWest().lat,n.getNorthEast().lng),i,this.strokeStart,this.strokeEnd,[])};this.map.on("mousemove",e),this.map.on("mouseup",o)}enableDrawing(){this.map.dragging.disable(),this.map.scrollWheelZoom.disable(),this.map.doubleClickZoom.disable(),this.map.getContainer().style.cursor="crosshair"}disableDrawing(){this.map.dragging.enable(),this.map.scrollWheelZoom.enable(),this.map.doubleClickZoom.enable(),this.map.getContainer().style.cursor="crosshair"}addFeature(t){t&&this.geoJsonLayer.addData(t)}removeFeature(t){const e=this.featureLayers.get(t);e&&(this.geoJsonLayer.removeLayer(e),this.featureLayers.delete(t))}displayInfo(t,e,o){const i=document.createElement("div");i.innerHTML=t;const s=L.popup({closeButton:!0}).setLatLng([e.lat,e.lon]).setContent(i).openOn(this.map);if(s&&o&&o.length)for(let t=0;t<o.length;t++){const e=i.querySelector(o[t].selector);e&&o[t].handler&&e.addEventListener("click",e=>{o[t].closeInfo&&s.remove(),o[t].handler(e)})}}clearInk(){this.strokePoly&&(this.map.removeLayer(this.strokePoly),this.strokePoly=null)}getBounds(){return this.map.getBounds()}getIsoTimestamp(){return(new Date).toISOString()}}class _{async connect(t,e,o){this.onStpMessage?.(`Connected to mock STP (${t||"Mock"})`,"Info")}async disconnect(t){this.onStpMessage?.("Disconnected from mock STP","Info")}sendPenDown(t,e){}sendInk(t,e,o,i,s,n,r){this.onInkProcessed?.();const a=`mock-${Date.now()}`,c=i&&i.length<=2,l=c?i[0]:i[Math.floor(i.length/2)],d=new z(a,l,i,c?"point":"line");d.affiliation="friend",d.fullDescription=c?"Mock Point":"Mock Graphic",d.description=d.fullDescription,this.onSymbolAdded?.([d],!1)}sendSpeechRecognition(t,e,o){const i=(t||[]).map(t=>t.text);this.onSpeechRecognized?.(i)}deleteSymbol(t){this.onSymbolDeleted?.(t,!1)}}class z{constructor(t,e,o,i){this.poid=t,this.location={fsTYPE:"point"===i?"point":"line",shape:i,centroid:e,coords:o||[]},this.affiliation="unknown",this.fullDescription="Mock Symbol",this.description=this.fullDescription,this.sidc={}}asGeoJSON(){const t="point"===this.location.fsTYPE;return{type:"Feature",id:this.poid,properties:{poid:this.poid,symbol:this,description:this.description,affiliation:this.affiliation},geometry:t?{type:"Point",coordinates:[this.location.centroid.lon,this.location.centroid.lat]}:{type:"LineString",coordinates:(this.location.coords||[]).map(t=>[t.lon,t.lat])}}}}let U,F,x="<Enter your Azure Speech subscription key here>",N="<Enter Azure's subscription region>",q=null,G=new T(58.967774948,11.196062412),B=13,j="ws://<STP server>:<STP port>";function J(t,e,o){o&&alert(t);let i=document.getElementById("messages");if(!i)throw new Error("Html page must contain a 'messages' div");i.innerHTML=t,i.style.color="Error"===e?"red":"black"}window.onload=()=>async function(){const t=new URLSearchParams(window.location.search);t.get("mapkey");const e=t.get("lat"),o=t.get("lon");e&&o&&(G=new T(parseFloat(e),parseFloat(o)));const i=t.get("zoom");i&&(B=parseInt(i));const s=t.get("azkey");s&&(x=s);const n=t.get("azregion");n&&(N=n);t.get("azlang");const r=t.get("azendp");r&&(q=r);const a=t.get("stpurl");a&&(j=a);const c=new O(j);U=new b(c),U.onSymbolAdded=(t,e)=>{let o=new E(t[0]).asGeoJSON();F.addFeature(o)},U.onSymbolModified=(t,e,o)=>{F.removeFeature(t);let i=new E(e).asGeoJSON();F.addFeature(i)},U.onSymbolDeleted=(t,e)=>{F.removeFeature(t)},U.onInkProcessed=()=>{F.clearInk()},U.onSpeechRecognized=t=>{let e="";t&&t.length>0&&(e=t[0]),J(e)},U.onStpMessage=(t,e)=>{J(t,e,!0)};const l=null!==t.get("mock");try{if(l)throw new Error("Mock requested");await U.connect("LeafletSampleTS",10)}catch(t){U=new _,await U.connect("LeafletSampleTS-Mock",1),J("Using mock STP locally (no backend)")}F=new I(null,"map",G,B),F.onStrokeStart=(t,e)=>{U.sendPenDown(t,e),async function(){try{const t=new P(x,N,q);let e=await t.recognizeOnce();if(e){const t=e.startTime?.toISOString?.()??String(e.startTime),o=e.endTime?.toISOString?.()??String(e.endTime);U.sendSpeechRecognition(e.results,t,o),e.results&&e.results.length>0&&J(e.results[0].text)}}catch(t){J("Failed to process speech: "+t.message)}}()},F.onStrokeCompleted=(t,e,o,i,s,n,r)=>{U.sendInk(t,e,o,i,s,n,r)},F.onSelection=t=>{let e=function(t){if(!t||!t.location||!t.location.centroid)return null;let e='<h3 id="firstHeading" class="firstHeading">'+t.fullDescription+"</h3><table><tr><td>2525D PartA</td><td>"+t.sidc?.partA+"</td></tr><tr><td>2525D PartB</td><td>"+t.sidc?.partB+"</td></tr><tr><td>Symbol Set</td><td>"+t.sidc?.symbolSet+"</td></tr><tr><td>2525C SIDC</td><td>"+t.sidc?.legacy+"</td></tr><tr><td>Affiliation</td><td>"+t.affiliation+"</td></tr>";"unit"==t.fsTYPE&&(e+="<tr><td>Echelon</td><td>"+t.echelon+"</td></tr>");e+="<tr><td>Parent Unit</td><td>"+t.parent+"</td></tr><tr><td>Designator 1</td><td>"+t.designator1+"</td></tr><tr><td>Designator 2</td><td>"+t.designator2+"</td></tr><tr><td>Status</td><td>"+t.status+"</td></tr>","unit"==t.fsTYPE&&(e+="<tr><td>Modifier</td><td>"+t.modifier+"</td></tr><tr><td>Strength</td><td>"+t.strength+"</td></tr>");return e+="<tr><td>Time From</td><td>"+t.timeFrom+"</td></tr><tr><td>Time To</td><td>"+t.timeTo+"</td></tr><tr><td>Altitude</td><td>"+t.altitude+"</td></tr><tr><td>Min Altitude</td><td>"+t.minAltitude+"</td></tr><tr><td>Max Altitude</td><td>"+t.maxAltitude+'</td></tr><tr><td><button id="delButton">Delete</button></td></tr></table>',e}(t);e&&t&&t.poid&&t.location&&t.location.centroid&&F.displayInfo(e,t.location.centroid,[{selector:"#delButton",handler:e=>{U.deleteSymbol(t.poid)},closeInfo:!0}])},F.load()}()}(SpeechSDK);