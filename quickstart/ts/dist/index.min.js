!function(t){class e{constructor(t,e=50){this.symbol=t,this.size=e}asGeoJSON(){let t=this.symbol.asGeoJSON(),e=this.getGestureGeometry(this.symbol);t.geometry=e;let o=this.asSVG();return o&&(t.properties.rendering=o),t}asSVG(){var t;if("point"==(null===(t=this.symbol.location)||void 0===t?void 0:t.fsTYPE)){return[this.pointSVG(this.symbol)]}return null}getGestureGeometry(e){var o,n,i,r,l,s,a;if(null==e.location||null==e.location||null==e.location.coords||0==e.location.coords.length||null==e.location.centroid)throw new Error("Symbol does not have location information");let d;if("point"==e.location.shape)d={type:"Point",coordinates:[e.location.centroid.lon,e.location.centroid.lat]};else if(d=this.toLineString(e.location.coords),null!=(null===(o=e.location)||void 0===o?void 0:o.shape)&&(null===(n=e.location)||void 0===n?void 0:n.shape.includes("arrowfat"))){let t=e.location.coords.slice(0,e.location.coords.length-1).reverse();t.push(e.location.coords[e.location.coords.length-1]),d=this.toLineString(t)}else if("ubend"==(null===(i=e.location)||void 0===i?void 0:i.shape)){let t=[e.location.coords[0],e.location.coords[2],e.location.coords[3],e.location.coords[1]];d=this.toLineString(t)}else if("ubendthreepoints"==(null===(r=e.location)||void 0===r?void 0:r.shape)){let o=new t.LatLon(e.location.coords[1].lat,e.location.coords[2].lon),n=[e.location.coords[0],e.location.coords[2],o,e.location.coords[1]];d=this.toLineString(n)}else if("vee"==(null===(l=e.location)||void 0===l?void 0:l.shape)){let t=[e.location.coords[1],e.location.coords[0],e.location.coords[2]];d=this.toLineString(t)}else"opencircle"==(null===(s=e.location)||void 0===s?void 0:s.shape)||"multipoint"==(null===(a=e.location)||void 0===a?void 0:a.shape)&&(d={type:"MultiPoint",coordinates:e.location.coords.map((t=>[t.lon,t.lat]))});return d}pointSVG(t){if(null==t.location||null==t.location||null==t.location.centroid)throw new Error("Point symbol does not have a defined centroid");let e,o,n,i,r,l=0,s="";const a=1.42;if("friend"===t.affiliation)i=this.size-2,r=this.size/a-2,e="rect",o='width="'+i+'" height="'+r+'" ',n="#80e0ff";else if("hostile"===t.affiliation){let t=this.size/a-2;i=r=t*Math.SQRT2,e="rect",o='width="'+t+'" height="'+t+'" ',n="#ff8080",l=45,s='transform="translate('+i/2+" 0) rotate("+l+')" '}else"neutral"===t.affiliation?(i=r=this.size/a-2,e="rect",o='width="'+i+'" height="'+r+'" ',n="#aaffaa"):(i=r=this.size/a-2,e="circle",o='cx="'+i/2+'" cy="'+r/2+'" r="'+i/2+'" ',n="#ffff80");let d,c='<svg xmlns="http://www.w3.org/2000/svg" version="1.2" baseProfile="tiny" width="'+i+'" height="'+r+'" viewBox="0 0 '+i+" "+r+'" > <'+e+" "+o+' stroke="black" stoke-width="1" fill="'+n+'" '+s+"/></svg>";if(l>0){const t=this.getTransform(c,e);d=[this.applyTransform(t,{x:0,y:0}),this.applyTransform(t,{x:i,y:0}),this.applyTransform(t,{x:i,y:r}),this.applyTransform(t,{x:0,y:r})]}else d=[{x:0,y:0},{x:i,y:0},{x:i,y:r},{x:0,y:r}];return{type:"icon",title:t.description,topLeft:t.location.centroid,bottomRight:t.location.centroid,position:t.location.centroid,svg:btoa(c),shape:d,anchor:{x:i/2,y:r/2}}}getTransform(t,e){let o=document.createElement("div");document.body.appendChild(o),o.setAttribute("style","position:absolute; padding:0; margin:0;visibility:hidden; width:0; height:0"),o.insertAdjacentHTML("beforeend",t);let n=o.querySelector(e),i=null==n?void 0:n.getCTM();return document.body.removeChild(o),i?[i.a,i.b,i.c,i.d,i.e,i.f]:[1,0,0,1,0,0]}toLineString(t){return{type:"LineString",coordinates:t.map((t=>[t.lon,t.lat]))}}applyTransform(t,e){return{x:e.x*t[0]+e.y*t[2]+t[4],y:e.x*t[1]+e.y*t[3]+t[5]}}}var o=function(t,e,o,n){return new(o||(o=Promise))((function(i,r){function l(t){try{a(n.next(t))}catch(t){r(t)}}function s(t){try{a(n.throw(t))}catch(t){r(t)}}function a(t){var e;t.done?i(t.value):(e=t.value,e instanceof o?e:new o((function(t){t(e)}))).then(l,s)}a((n=n.apply(t,e||[])).next())}))};class n{constructor(t,e,o,n){this.apiKey=t,this.mapDivId=e,this.mapCenter=o,this.zoomLevel=n,this.strokeStart=this.strokeEnd="",this.assets=new Map}load(){return o(this,void 0,void 0,(function*(){const t="https://maps.googleapis.com/maps/api/js?key="+this.apiKey;document.querySelectorAll('[src="'+t+'"]').length?yield this.initMap():document.body.appendChild(Object.assign(document.createElement("script"),{type:"text/javascript",src:t,onload:()=>o(this,void 0,void 0,(function*(){return yield this.initMap()}))}))}))}initMap(){return o(this,void 0,void 0,(function*(){const e=document.getElementById(this.mapDivId);if(!e)throw new Error("Html page must contain a 'map' div");this.map=new google.maps.Map(e,{zoom:this.zoomLevel,center:{lat:this.mapCenter.lat,lng:this.mapCenter.lon},gestureHandling:"cooperative",draggable:!0,draggableCursor:"crosshair"}),this.map.data.setStyle((t=>{let e=t.getProperty("rendering");if(e){for(let o=0;o<e.length;o++){let n=e[o].shape.map((t=>[t.x,t.y])).flat(),i=new google.maps.Marker({map:this.map,icon:{url:"data:image/svg+xml;charset=UTF-8;base64,"+e[o].svg,anchor:new google.maps.Point(e[o].anchor.x,e[o].anchor.y)},shape:{type:"poly",coords:n},position:{lat:e[o].position.lat,lng:e[o].position.lon}});e[o].title&&i.setTitle(e[o].title),i.addListener("click",(()=>{var e;null===(e=this.onSelection)||void 0===e||e.call(this,t.getProperty("symbol"))}));let r=t.getProperty("symbol").poid;this.assets.has(r)?this.assets.get(r).push(i):this.assets.set(r,[i])}return{visible:"Point"!=t.getGeometry().getType()}}return{visible:!0}})),this.map.data.addListener("click",(t=>{var e;null===(e=this.onSelection)||void 0===e||e.call(this,t.feature.getProperty("symbol"))})),this.map.addListener("mousedown",(e=>{var o;if(e.domEvent.ctrlKey)return!1;e.domEvent.preventDefault(),this.enableDrawing(),null===(o=this.onStrokeStart)||void 0===o||o.call(this,new t.LatLon(e.latLng.lat(),e.latLng.lng()),this.getIsoTimestamp()),this.drawFreeHand(e.latLng)}))}))}drawFreeHand(e){this.strokeStart=this.getIsoTimestamp(),this.clearInk(),this.strokePoly=new google.maps.Polyline({map:this.map,clickable:!1,strokeColor:"#8B0000",strokeWeight:2}),this.strokePoly.getPath().push(e),this.moveListener=google.maps.event.addListener(this.map,"mousemove",(t=>{this.strokePoly.getPath().push(t.latLng)})),google.maps.event.addListenerOnce(this.map,"mouseup",(e=>{this.strokeEnd=this.getIsoTimestamp(),this.moveListener&&google.maps.event.removeListener(this.moveListener),this.enableDragZoom();let o=this.strokePoly.getPath();1==o.getLength()&&o.push(o.getAt(0));let n=o.getArray().map((e=>new t.LatLon(e.lat(),e.lng()))),i={width:document.getElementById("map").clientWidth,height:document.getElementById("map").clientHeight},r=this.map.getBounds();if(!r)throw new Error("Failed to retrieve the map bounds - unable to send ink to STP");this.onStrokeCompleted&&this.onStrokeCompleted(new t.Size(i.width,i.height),new t.LatLon(r.getNorthEast().lat(),r.getSouthWest().lng()),new t.LatLon(r.getSouthWest().lat(),r.getNorthEast().lng()),n,this.strokeStart,this.strokeEnd,[])}))}enableDrawing(){this.map.setOptions({draggable:!1,zoomControl:!1,scrollwheel:!1,disableDoubleClickZoom:!1})}enableDragZoom(){this.map.setOptions({draggable:!0,zoomControl:!0,scrollwheel:!0,disableDoubleClickZoom:!0})}addFeature(t){let o=new e(t).asGeoJSON();this.map.data.addGeoJson(o)}removeFeature(t){let e=this.map.data.getFeatureById(t);if(e){if(this.assets.has(t)){let e=this.assets.get(t);for(let t=0;t<e.length;t++)e[t].setMap(null)}this.map.data.remove(e)}}displayInfo(t,e,o){let n=document.createElement("div");n.innerHTML=t;let i={lat:e.lat,lng:e.lon},r=new google.maps.InfoWindow({content:n,position:i});if(r&&o&&o.length)for(let t=0;t<o.length;t++){let e=n.querySelector(o[t].selector);e&&o[t].handler&&google.maps.event.addDomListener(e,"click",(e=>{o[t].closeInfo&&r.close(),o[t].handler(e)}))}r.open(this.map)}clearInk(){var t;null===(t=this.strokePoly)||void 0===t||t.setMap(null)}getIsoTimestamp(){return(new Date).toISOString()}}var i=function(t,e,o,n){return new(o||(o=Promise))((function(i,r){function l(t){try{a(n.next(t))}catch(t){r(t)}}function s(t){try{a(n.throw(t))}catch(t){r(t)}}function a(t){var e;t.done?i(t.value):(e=t.value,e instanceof o?e:new o((function(t){t(e)}))).then(l,s)}a((n=n.apply(t,e||[])).next())}))};const r="<Enter your Azure Speech subscription key here>",l="<Enter Azure's subscription region>",s="<Enter your Google Maps API key here>",a=new t.LatLon(58.967774948,11.196062412),d="ws://<STP server>:<STP port>";let c,h;function p(t,e,o){o&&alert(t);let n=document.getElementById("messages");if(!n)throw new Error("Html page must contain a 'messages' div");n.innerHTML=t,n.style.color="Error"===e?"red":"black"}window.onload=()=>function(){return i(this,void 0,void 0,(function*(){const e=new URLSearchParams(window.location.search),o=e.get("lat"),u=e.get("lon"),m=o&&u?new t.LatLon(parseFloat(o),parseFloat(u)):a,g=e.get("zoom"),f=g?parseInt(g):13,v=e.get("stpurl"),y=v||d;e.get("role");const w=new t.StpWebSocketsConnector(y);c=new t.StpRecognizer(w),c.onSymbolAdded=(t,e)=>{h.addFeature(t[0])},c.onSymbolModified=(t,e,o)=>{h.removeFeature(t),h.addFeature(e)},c.onSymbolDeleted=(t,e)=>{h.removeFeature(t)},c.onInkProcessed=()=>{h.clearInk()},c.onSpeechRecognized=t=>{let e="";t&&t.length>0&&(e=t[0]),p(e)},c.onStpMessage=(t,e)=>{p(t,e,!0)};try{yield c.connect("GoogleMapsSample",10)}catch(e){return void p("Failed to connect to STP at "+y+". \nSymbols will not be recognized. Please reload to try again",t.StpMessageLevel.Error,!0)}h=new n(s,"map",m,f),h.onStrokeStart=(e,o)=>{c.sendPenDown(e,o),function(){i(this,void 0,void 0,(function*(){try{const e=new t.AzureSpeechRecognizer(r,l,null);let o=yield e.recognize();o&&(c.sendSpeechRecognition(o.results,o.startTime,o.endTime),o.results&&o.results.length>0&&p(o.results[0].text))}catch(t){p("Failed to process speech: "+t.message)}}))}()},h.onStrokeCompleted=(t,e,o,n,i,r,l)=>{c.sendInk(t,e,o,n,i,r,l)},h.onSelection=t=>{let e=function(t){var e,o,n,i;if(!t||!t.location||!t.location.centroid)return null;let r='<h3 id="firstHeading" class="firstHeading">'+t.fullDescription+"</h3><table><tr><td>2525D PartA</td><td>"+(null===(e=t.sidc)||void 0===e?void 0:e.partA)+"</td></tr><tr><td>2525D PartB</td><td>"+(null===(o=t.sidc)||void 0===o?void 0:o.partB)+"</td></tr><tr><td>Symbol Set</td><td>"+(null===(n=t.sidc)||void 0===n?void 0:n.symbolSet)+"</td></tr><tr><td>2525C SIDC</td><td>"+(null===(i=t.sidc)||void 0===i?void 0:i.legacy)+"</td></tr><tr><td>Affiliation</td><td>"+t.affiliation+"</td></tr>";"unit"==t.fsTYPE&&(r+="<tr><td>Echelon</td><td>"+t.echelon+"</td></tr>");r+="<tr><td>Parent Unit</td><td>"+t.parent+"</td></tr><tr><td>Designator 1</td><td>"+t.designator1+"</td></tr><tr><td>Designator 2</td><td>"+t.designator2+"</td></tr><tr><td>Status</td><td>"+t.status+"</td></tr>","unit"==t.fsTYPE&&(r+="<tr><td>Modifier</td><td>"+t.modifier+"</td></tr><tr><td>Strength</td><td>"+t.strength+"</td></tr>");return r+="<tr><td>Time From</td><td>"+t.timeFrom+"</td></tr><tr><td>Time To</td><td>"+t.timeTo+"</td></tr><tr><td>Altitude</td><td>"+t.altitude+"</td></tr><tr><td>Min Altitude</td><td>"+t.minAltitude+"</td></tr><tr><td>Max Altitude</td><td>"+t.maxAltitude+'</td></tr><tr><td><button id="delButton">Delete</button></td></tr></table>',r}(t);e&&t&&t.poid&&t.location&&t.location.centroid&&h.displayInfo(e,t.location.centroid,[{selector:"#delButton",handler:e=>{c.deleteSymbol(t.poid)},closeInfo:!0}])},h.load()}))}()}(StpSDK);