!function(e){function t(e){var t=Object.create(null);return e&&Object.keys(e).forEach(function(i){if("default"!==i){var o=Object.getOwnPropertyDescriptor(e,i);Object.defineProperty(t,i,o.get?o:{enumerable:!0,get:function(){return e[i]}})}}),t.default=e,Object.freeze(t)}var i,o,s,n,r,a,l,c,d,h=t(e);function p(e,t){let i,o=e&&e.type;if("FeatureCollection"===o){let o=e;for(i=0;i<o.features.length;i++)p(o.features[i],t)}else if("GeometryCollection"===o){let o=e;for(i=0;i<o.geometries.length;i++)p(o.geometries[i],t)}else if("Feature"===o){p(e.geometry,t)}else if("Polygon"===o){u(e.coordinates,t)}else if("MultiPolygon"===o){let o=e;for(i=0;i<o.coordinates.length;i++)u(o.coordinates[i],t)}return e}function u(e,t){if(0!==e.length){g(e[0],t);for(let i=1;i<e.length;i++)g(e[i],!t)}}function g(e,t){let i=0;for(let t=0,o=e.length,s=o-1;t<o;s=t++)i+=(e[t][0]-e[s][0])*(e[s][1]+e[t][1]);i>=0!=!!t&&e.reverse()}!function(e){e.Error="Error",e.Warning="Warning",e.Info="Info",e.Debug="Debug"}(i||(i={})),function(e){e.s2="S2",e.s3="S3",e.s4="S4",e.fso="FSO",e.eng="ENG"}(o||(o={}));class m{}class f extends m{asGeoJSON(){if(null==this.location||null==this.location.coords||0==this.location?.coords.length)throw new Error("Coordinates are undefined or empty");let e;if("point"===this.location?.fsTYPE)e={type:"Point",coordinates:[this.location.coords[0].lon,this.location.coords[0].lat]};else if("line"===this.location?.fsTYPE)e={type:"LineString",coordinates:this.location.coords.map(e=>[e.lon,e.lat])};else if("area"===this.location?.fsTYPE)e={type:"Polygon",coordinates:[this.location.coords.map(e=>[e.lon,e.lat])]},e=p(e,!1);else{if("multipoint"!==this.location?.fsTYPE)throw new Error('Expected "point", "line", "area", or "multipoint" geometry type. Got: '+this.location?.fsTYPE);e={type:"MultiPoint",coordinates:this.location.coords.map(e=>[e.lon,e.lat])}}return{type:"Feature",id:this.poid,geometry:e,properties:{symbol:this}}}}class y{}class S extends f{}class k{}!function(e){e.None="none",e.Organic="organic",e.Attached="attached",e.Assigned="assigned",e.AdCon="adcon",e.OpCon="opcon",e.TaCon="tacon",e.DirectSupport="ds",e.Reinforcing="r",e.GeneralSupportReinforcing="gsr",e.GeneralSupport="gs"}(s||(s={}));class w extends m{}class T{}!function(e){e.NotSpecified="not_specified",e.AdvisePolice="advise_police",e.Ambush="ambush",e.AssignResponsibility="assign_responsibility",e.Block="block",e.BombAttack="bomb_attack",e.Breach="breach",e.Bypass="bypass",e.Clear="clear",e.CoerciveRecruiting="coercive_recruiting",e.CollectCasualties="collect_casualties",e.CollectCivilians="collect_civilians",e.CollectPrisoners="collect_prisoners",e.ConductAmbush="conduct_ambush",e.ConductAviatonAmbush="conduct_aviaton_ambush",e.ConductBilat="conduct_bilat",e.ConductGroupEngagement="conduct_group_engagement",e.ConductRaid="conduct_raid",e.ConductTcpOperation="conduct_tcp_operation",e.ConstituteReserve="constitute_reserve",e.Convoy="convoy",e.Defeat="defeat",e.Delay="delay",e.DeliverLeafletPsyop="deliver_leaflet_psyop",e.Demonstrate="demonstrate",e.Destroy="destroy",e.Disrupt="disrupt",e.DistributeFood="distribute_food",e.Emplace="emplace",e.EquipPolice="equip_police",e.EscortConvoy="escort_convoy",e.EvacuateCasualties="evacuate_casualties",e.EvacuateCivilians="evacuate_civilians",e.EvacuatePrisoners="evacuate_prisoners",e.Fix="fix",e.Follow="follow",e.FollowAndAssume="follow_and_assume",e.FollowAndSupport="follow_and_support",e.Halt="halt",e.HarrassmentFires="harrassment_fires",e.HouseToHousePsyop="house_to_house_psyop",e.IedAttack="ied_attack",e.Limit="limit",e.Looting="looting",e.MaintainHide="maintain_hide",e.MaintainOutpost="maintain_outpost",e.Move="move",e.Neutralize="neutralize",e.Observe="observe",e.Occupy="occupy",e.Patrol="patrol",e.Penetrate="penetrate",e.PositionSniper="position_sniper",e.PriorityOfFires="priority_of_fires",e.ProvideMedicalServices="provide_medical_services",e.ProvideService="provide_service",e.Receive="receive",e.Reconstruction="reconstruction",e.RecruitPolice="recruit_police",e.Refuel="refuel",e.RegulateTraffic="regulate_traffic",e.Reinforce="reinforce",e.Release="release",e.Resupply="resupply",e.Retain="retain",e.Rioting="rioting",e.Secure="secure",e.SeekRefuge="seek_refuge",e.Seize="seize",e.SniperAttack="sniper_attack",e.Supply="supply",e.SupplyMunitions="supply_munitions",e.TrainPolice="train_police",e.TransferMunitions="transfer_munitions",e.TrashRemoval="trash_removal",e.Turn="turn",e.TvRadioPsyop="tv_radio_psyop",e.WaterDelivery="water_delivery",e.WillfulRecruiting="willful_recruiting"}(n||(n={})),function(e){e.NotSpecified="not_specified",e.AirAssault="air_assault",e.AirReconnaissance="air_reconnaissance",e.AreaDefense="area_defense",e.Assault="assault",e.Attack="attack",e.AttackInZone="attack_in_zone",e.AttackByFire="attack_by_fire",e.CerpFunding="cerp_funding",e.Civilian="civilian",e.Contracting="contracting",e.CordonAndSearch="cordon_and_search",e.Counterattack="counterattack",e.CounterattackByFire="counterattack_by_fire",e.Cover="cover",e.Defend="defend",e.DeliverServices="deliver_services",e.Guard="guard",e.InformationOperations="information_operations",e.Insurgent="insurgent",e.MobileDefense="mobile_defense",e.MovingScreen="moving_screen",e.NgoOperation="ngo_operation",e.PassageOfLines="passage_of_lines",e.Screen="screen",e.SearchAndAttack="search_and_attack",e.Security="security",e.SecurityForceAssistance="security_force_assistance",e.SupportByFire="support_by_fire",e.Withdrawal="withdrawal"}(r||(r={})),function(e){e.Unknown="unknown",e.Allow="allow",e.Cause="cause",e.Create="create",e.Deceive="deceive",e.Deny="deny",e.Divert="divert",e.Enable="enable",e.Envelop="envelop",e.Influence="influence",e.Open="open",e.Prevent="prevent",e.Protect="protect",e.Support="support",e.Surprise="surprise"}(a||(a={})),function(e){e.NotSpecified="not_specified",e.Hold="hold",e.Tight="tight",e.Free="free"}(l||(l={}));class b{constructor(e,t){this.lat=e,this.lon=t}equals(e){return this.lat==e.lat&&this.lon==e.lon}}class v{constructor(e,t){this.width=e,this.height=t}equals(e){return this.width==e.width&&this.height==e.height}}class C{constructor(e,t){this.stpsdk=e,this.options=t,e.onSymbolReport=(e,t)=>{this.onSymbolReport&&this.onSymbolReport(e,t)}}async exportPlanDataToC2SIMServer(e,t,i,o,s){let n=await this.getC2SIMContent(e,t,i,o,s);n&&await this.pushC2SIMContent(n,t,s)}async importInitializationFromC2SIMServer(e){let t=await this.pullC2SIMInitialization(e),i=await this.convertC2SIMContent(t,e);await this.stpsdk.syncScenarioSession(i,e)}async getC2SIMContent(e,t,i,o,s){return this.stpsdk.requestStp("GetC2SIMContent",{name:arguments[0],dataType:arguments[1],affiliation:arguments[2],coaPoids:arguments[3],options:this.options},s)}async pushC2SIMContent(e,t,i){return this.stpsdk.requestStp("PushC2SIMContent",{content:arguments[0],dataType:arguments[1],options:this.options},i)}async pullC2SIMInitialization(e){return this.stpsdk.requestStp("PullC2SIMInitialization",{options:this.options},e)}async convertC2SIMContent(e,t){return this.stpsdk.requestStp("ConvertC2SIMContent",{content:arguments[0],options:this.options},t)}}class O{constructor(e){this.stpConnector=e,this.serviceName=""}async connect(e,t,i,o){this.serviceName=e,this.stpConnector.onInform=this.onInform.bind(this),this.stpConnector.onRequest=this.onRequest.bind(this),this.stpConnector.onError=this.onError.bind(this);try{let e=this.buildSolvables();return this.stpConnector.connect(this.serviceName,e,t,i,o)}catch(e){throw e}}buildSolvables(){return Object.getOwnPropertyNames(this).filter(e=>e.toString().startsWith("on")&&"function"==typeof this[e]).map(e=>e.substring(2))}onInform(e){let t=JSON.parse(e);this.handleInform(t)}onRequest(e){return this.onInform(e),[]}onError(e){this.onStpMessage&&this.onStpMessage(e,i.Error)}handleInform(e){if("SymbolAdded"===e.method&&this.onSymbolAdded){const t=e.params;let i=[];for(let e=0;e<t.alternates.length;e++){const o=Object.assign(new f,t.alternates[e]);i.push(o)}this.onSymbolAdded(i,t.isUndo)}else if("SymbolModified"===e.method&&this.onSymbolModified){const t=e.params,i=Object.assign(new f,t.symbol);this.onSymbolModified(t.poid,i,t.isUndo)}else if("SymbolDeleted"===e.method&&this.onSymbolDeleted){const t=e.params;this.onSymbolDeleted(t.poid,t.isUndo)}else if("SymbolReport"===e.method&&this.onSymbolReport){const t=e.params,i=Object.assign(new f,t.symbol);this.onSymbolReport(t.poid,i)}else if("TaskOrgAdded"===e.method&&this.onTaskOrgAdded||"TaskOrgModified"===e.method&&this.onTaskOrgModified){const t=e.params,i=Object.assign(new y,t.taskOrg);"TaskOrgAdded"===e.method&&this.onTaskOrgAdded?this.onTaskOrgAdded(i,t.isUndo):"TaskOrgModified"===e.method&&this.onTaskOrgModified&&this.onTaskOrgModified(t.poid,i,t.isUndo)}else if("TaskOrgDeleted"===e.method&&this.onTaskOrgDeleted){const t=e.params;this.onTaskOrgDeleted(t.poid,t.isUndo)}else if("TaskOrgUnitAdded"===e.method&&this.onTaskOrgUnitAdded||"TaskOrgUnitModified"===e.method&&this.onTaskOrgUnitModified){const t=e.params,i=Object.assign(new S,t.toUnit);"TaskOrgUnitAdded"===e.method&&this.onTaskOrgUnitAdded?this.onTaskOrgUnitAdded(i,t.isUndo):"TaskOrgUnitModified"===e.method&&this.onTaskOrgUnitModified&&this.onTaskOrgUnitModified(t.poid,i,t.isUndo)}else if("TaskOrgUnitDeleted"===e.method&&this.onTaskOrgUnitDeleted){const t=e.params;this.onTaskOrgUnitDeleted(t.poid,t.isUndo)}else if("TaskOrgRelationshipAdded"===e.method&&this.onTaskOrgRelationshipAdded||"TaskOrgRelationshipModified"===e.method&&this.onTaskOrgRelationshipModified){const t=e.params,i=Object.assign(new k,t.toRelationship);"TaskOrgRelationshipAdded"===e.method&&this.onTaskOrgRelationshipAdded?this.onTaskOrgRelationshipAdded(i,t.isUndo):"TaskOrgRelationshipModified"===e.method&&this.onTaskOrgRelationshipModified&&this.onTaskOrgRelationshipModified(t.poid,i,t.isUndo)}else if("TaskOrgRelationshipDeleted"===e.method&&this.onTaskOrgRelationshipDeleted){const t=e.params;this.onTaskOrgRelationshipDeleted(t.poid,t.isUndo)}else if("TaskAdded"===e.method&&this.onTaskAdded||"TaskModified"===e.method&&this.onTaskModified){const t=e.params;let i=[];for(let e=0;e<t.alternates.length;e++){const o=Object.assign(new w,t.alternates[e]);i.push(o)}"TaskAdded"===e.method&&this.onTaskAdded?this.onTaskAdded(t.poid,i,t.taskPoids,t.isUndo):"TaskModified"===e.method&&this.onTaskModified&&this.onTaskModified(t.poid,i,t.taskPoids,t.isUndo)}else if("TaskDeleted"===e.method&&this.onTaskDeleted){const t=e.params;this.onTaskDeleted(t.poid,t.isUndo)}else if("TaskOrgSwitched"===e.method&&this.onTaskOrgSwitched){const t=e.params;this.onTaskOrgSwitched(t.taskOrg)}else if("CoaAdded"===e.method&&this.onCoaAdded||"CoaModified"===e.method&&this.onCoaModified){const t=e.params,i=Object.assign(new T,t.coa);"CoaAdded"===e.method&&this.onCoaAdded?this.onCoaAdded(t.poid,t.coa,t.isUndo):"CoaModified"===e.method&&this.onCoaModified&&this.onCoaModified(t.poid,i,t.isUndo)}else if("CoaDeleted"===e.method&&this.onCoaDeleted){const t=e.params;this.onCoaDeleted(t.poid,t.isUndo)}else if("RoleSwitched"===e.method&&this.onRoleSwitched){const t=e.params;this.onRoleSwitched(t.role)}else if("InkProcessed"===e.method&&this.onInkProcessed)this.onInkProcessed();else if("SpeechRecognized"===e.method&&this.onSpeechRecognized){const t=e.params;this.onSpeechRecognized(t.phrases)}else if("SymbolEdited"===e.method&&this.onSymbolEdited){const t=e.params;this.onSymbolEdited(t.operation,t.location)}else if("MapOperation"===e.method&&this.onMapOperation){const t=e.params;this.onMapOperation(t.operation,t.location)}else if("Command"===e.method&&this.onCommand){const t=e.params;this.onCommand(t.operation,t.location)}else if("StpMessage"===e.method&&this.onStpMessage){const t=e.params;this.onStpMessage(t.message,t.level)}else console.log("Received message with no handler: "+e.method)}informStp(e,t){try{let i={method:e,params:t};this.stpConnector.inform(JSON.stringify(i))}catch(e){this.onStpMessage&&this.onStpMessage(e.message,i.Error)}}async requestStp(e,t,o){try{let i={method:e,params:t};return this.stpConnector.request(JSON.stringify(i),o)}catch(e){this.onStpMessage&&this.onStpMessage(e.message,i.Error)}}sendPenDown(e,t){this.informStp("SendPenDown",{location:arguments[0],timestamp:arguments[1]})}sendInk(e,t,i,o,s,n,r){this.informStp("SendInk",{pixelBoundsWindow:arguments[0],topLeftGeoMap:arguments[1],bottomRightGeoMap:arguments[2],strokePoints:arguments[3],timeStrokeStart:arguments[4],timeStrokeEnd:arguments[5],intersectedPoids:arguments[6]})}sendSpeechRecognition(e,t,i){this.informStp("SendSpeechRecognition",{recoList:arguments[0],startTime:arguments[1],endTime:arguments[2]})}async createNewScenario(e,t){return this.requestStp("CreateNewScenario",{name:arguments[0]},t)}async loadNewScenario(e,t){return this.requestStp("LoadNewScenario",{content:arguments[0]},t)}async importPlanData(e,t){return this.requestStp("ImportPlanData",{content:arguments[0]},t)}async getScenarioContent(e){return this.requestStp("GetScenarioContent",null,e)}async joinScenarioSession(e){return this.requestStp("JoinScenarioSession",null,e)}async syncScenarioSession(e,t){return this.requestStp("SyncScenarioSession",{content:arguments[0]},t)}async hasActiveScenario(e){return this.requestStp("HasActiveScenario",null,e)}createC2SIMProxy(e){return new C(this,e)}addSymbol(e){this.informStp("AddSymbol",{symbol:arguments[0]})}updateSymbol(e,t){this.informStp("UpdateSymbol",{poid:arguments[0],symbol:arguments[1]})}deleteSymbol(e){this.informStp("DeleteSymbol",{poid:arguments[0]})}chooseAlternate(e,t){this.informStp("ChooseAlternate",{poid:arguments[0],nBestIndex:arguments[1]})}async importTaskOrgContent(e,t){return this.requestStp("ImportTaskOrgContent",{content:arguments[0]},t)}async getTaskOrgContent(e,t){return this.requestStp("GetTaskOrgContent",{poid:arguments[0]},t)}async setDefaultTaskOrg(e,t){return this.requestStp("SetDefaultTaskOrg",{poid:arguments[0]},t)}async resetDefaultTaskOrg(e,t){return this.requestStp("ResetDefaultTaskOrg",{affiliation:arguments[0]},t)}addTaskOrg(e){this.informStp("AddTaskOrg",{taskOrg:arguments[0]})}updateTaskOrg(e,t){this.informStp("UpdateTaskOrg",{poid:arguments[0],taskOrg:arguments[1]})}deleteTaskOrg(e){this.informStp("DeleteTaskOrg",{poid:arguments[0]})}addTaskOrgUnit(e){this.informStp("AddTaskOrgUnit",{toUnit:arguments[0]})}updateTaskOrgUnit(e,t){this.informStp("UpdateTaskOrgUnit",{poid:arguments[0],toUnit:arguments[1]})}deleteTaskOrgUnit(e){this.informStp("DeleteTaskOrgUnit",{poid:arguments[0]})}addTaskOrgRelationship(e){this.informStp("AddTaskOrgRelationship",{toRelationship:arguments[0]})}updateTaskOrgRelationship(e,t){this.informStp("UpdateTaskOrgRelationship",{poid:arguments[0],toRelationship:arguments[1]})}deleteTaskOrgRelationship(e){this.informStp("DeleteTaskOrgRelationship",{poid:arguments[0]})}addTask(e){this.informStp("AddTask",{task:arguments[0]})}updateTask(e,t){this.informStp("UpdateTask",{poid:arguments[0],alternates:arguments[1]})}deleteTask(e){this.informStp("DeleteTask",{poid:arguments[0]})}confirmTask(e,t,i=!0){this.informStp("ConfirmTask",{poid:arguments[0],nBestIndex:arguments[1],isConfirmed:arguments[2]})}async setCoaTaskOrg(e,t,i){return this.requestStp("SetCoaTaskOrg",{toPoid:arguments[0],coaPoid:arguments[1]},i)}async resetCoaTaskOrg(e,t){return this.requestStp("SetCoaTaskOrg",{affiliation:arguments[0],coaPoid:arguments[1]},t)}async importCoaContent(e,t){return this.requestStp("ImportCoaContent",{content:arguments[0]},t)}async getCoaContent(e,t){return this.requestStp("GetCoaContent",{poid:arguments[0]},t)}async setCurrentCoa(e,t){return this.requestStp("SetCurrentCoa",{poid:arguments[0]},t)}addCoa(e){this.informStp("AddCoa",{coa:arguments[0]})}updateCoa(e,t){this.informStp("UpdateCoa",{poid:arguments[0],coa:arguments[1]})}deleteCoa(e){this.informStp("DeleteCoa",{poid:arguments[0]})}async setCurrentRole(e,t=!0,i){return this.requestStp("SetRole",{role:arguments[0]},i)}promiseWithTimeout(e,t){return Promise.race([t,new Promise((t,i)=>{let o=setTimeout(()=>{clearTimeout(o),i(new Error("Operation timed out"))},1e3*e)})])}}class I{get isConnected(){return null!=this.socket&&this.socket.readyState===this.socket.OPEN}get isConnecting(){return null!=this.socket&&this.socket.readyState===this.socket.CONNECTING}get connState(){return this.socket?this.socket.readyState.toString():""}constructor(e){this.DEFAULT_TIMEOUT=30,this.connstring=e,this.socket=null}async connect(e,t,i=this.DEFAULT_TIMEOUT,o=null,s=null){return new Promise(async(n,r)=>{this.isConnected&&n(this.sessionId),this.serviceName=e,this.solvables=t,null!=o&&(this.machineId=o),null!=s&&(this.sessionId=s),i<=0&&(i=this.DEFAULT_TIMEOUT);try{this.socket=await this.promiseWithTimeout(i,this.tryConnect(this.connstring))}catch(e){return void r(new Error("Failed to connect: "+e.message))}this.socket.onmessage=e=>{const t=JSON.parse(e.data);if("RequestResponse"===t.method){const e=t.params;let i=P.trackedResponses.findIndex(t=>t.cookie===e.cookie);if(P.trackedResponses.find(t=>t.cookie===e.cookie),i>-1){let t=P.trackedResponses.splice(i,1)[0];e.success?t.responseFuture.resolve(e.result):t.responseFuture.reject(e.result)}}else this.onInform&&this.onInform(e.data)},this.socket.onerror=e=>{this.onError&&this.onError("Error connecting to STP. Check that the service is running and refresh page to retry")},this.socket.onclose=async e=>{if(!this.isConnecting)try{await this.connect(this.serviceName,this.solvables,this.timeout,this.machineId)}catch(e){this.onError&&this.onError("Lost connection to STP. Check that the service is running and refresh page to retry")}};try{this.sessionId=await this.register(i)}catch(e){return void r(new Error("Failed to register with STP: "+e.message))}n(this.sessionId)})}register(e=this.DEFAULT_TIMEOUT){if(!this.isConnected)throw new Error("Failed to register: connection is not open ("+this.connState+")");this.name=this.serviceName;let t={method:"Register",params:{serviceName:this.serviceName,language:"javascript",solvables:this.solvables,machineId:this.machineId||this.getUniqueId(9),sessionId:this.sessionId}};return this.request(JSON.stringify(t),e)}disconnect(e=this.DEFAULT_TIMEOUT){return this.promiseWithTimeout(e,new Promise(async(e,t)=>{!this.isConnected&&this.socket&&this.socket.close(),e()}))}inform(e,t=this.DEFAULT_TIMEOUT){if(!this.isConnected)throw new Error("Failed to send inform: connection is not open ("+this.connState+")");return this.promiseWithTimeout(t,new Promise(async(t,i)=>{this.socket&&(this.socket.send(e),t())}))}async request(e,t=this.DEFAULT_TIMEOUT){if(!this.isConnected||!this.socket)throw new Error("Failed to send request: connection is not open ("+this.connState+")");let i=new P;return this.promiseWithTimeout(t,new Promise(async(o,s)=>{if(!this.socket)return;const n={method:"Request",params:{jsonRequest:e,cookie:i.cookie,timeout:t}};this.socket.send(JSON.stringify(n)),i.responseFuture.then(e=>o(e)).catch(e=>s(e))}))}tryConnect(e){return new Promise((t,i)=>{var o=new WebSocket(e);o.onopen=()=>t(o),o.onerror=e=>i(new Error("Unspecified error communicating with STP"))})}promiseWithTimeout(e,t){return Promise.race([t,new Promise((t,i)=>{let o=setTimeout(()=>{clearTimeout(o),i(new Error("Operation timed out"))},1e3*e)})])}getUniqueId(e){return e||(e=9),Math.random().toString(36).substr(2,e)}}class P{constructor(){this.cookie=P.lastCookie++,this.responseFuture=new E,P.trackedResponses.push(this)}}P.lastCookie=0,P.trackedResponses=[];class E{constructor(e){if(!(this instanceof E))return new E(e);this.promise=e||new Promise(this.promiseExecutor.bind(this))}asPromise(){return this.promise}then(e,t){return new E(this.promise.then(e,t))}catch(e){return new E(this.promise.catch(e))}resolve(e){this.resolveFunction(e)}reject(e){this.rejectFunction(e)}promiseExecutor(e,t){this.resolveFunction=e,this.rejectFunction=t}}class R{constructor(e,t,i,o,s){this.speechSubscriptionKey=e,this.serviceRegion=t,this.speechConfig=h.SpeechConfig.fromSubscription(this.speechSubscriptionKey,this.serviceRegion),this.speechConfig.speechRecognitionLanguage=s||"en-US",this.speechConfig.outputFormat=h.OutputFormat.Detailed,i&&(this.speechConfig.endpointId=i),this.audioConfig=o||h.AudioConfig.fromDefaultMicrophoneInput(),this.isListening=!1}setPhraseList(e){this.phraseList=e}initializeReco(){if(this.recognizer=new h.SpeechRecognizer(this.speechConfig,this.audioConfig),this.phraseList){h.PhraseListGrammar.fromRecognizer(this.recognizer).addPhrases(this.phraseList)}}recognizeOnce(e){return e||(e=8),this.initializeReco(),new Promise(async(t,i)=>{for(let i=0;i<e;i++){this.recoStart=new Date;try{return void t(await this.tryReco(this.recoStart))}catch(e){}i<e-1&&await new Promise(e=>setTimeout(e,250))}let o=new Error("Failed to recognize speech");this.onError?.call(this,o),i(o)})}tryReco(e){return new Promise((t,i)=>{this.recognizer.recognizing=(e,t)=>{this.onRecognizing?.call(this,t.result.text)},this.recognizer.recognized=(i,o)=>{let s=this.convertResults(e,o.result);this.onRecognized?.call(this,s),t(s)},this.recognizer.canceled=(e,t)=>{this.isListening=!1,i(new Error(h.CancellationReason[t.reason]))},this.isListening||(this.isListening=!0,this.recognizer?.recognizeOnceAsync(),this.isListening=!1)})}startRecognizing(){this.isListening||(this.initializeReco(),this.recoStart=new Date,this.recognizer.recognizing=(e,t)=>{this.onRecognizing?.call(this,t.result.text)},this.recognizer.recognized=(e,t)=>{let i=this.convertResults(this.recoStart,t.result);this.onRecognized?.call(this,i)},this.recognizer.canceled=(e,t)=>{this.isListening=!1;let i=new Error(h.CancellationReason[t.reason]);this.onError?this.onError.call(this,i):this.onRecognized?.call(this,null)},this.isListening=!0,this.recognizer.startContinuousRecognitionAsync())}stopRecognizing(e){this.recognizer&&setTimeout(()=>{this.recognizer?.close(),this.recognizer=void 0},e||0),this.isListening=!1}convertResults(e,t){if(t.reason===h.ResultReason.NoMatch)return null;let i=new A;i.startTime=this.addTicksToDate(e,t.offset),i.endTime=this.addTicksToDate(i.startTime,t.duration);let o=t.properties.getProperty(h.PropertyId.SpeechServiceResponse_JsonResult);const s=Object.assign(new _,JSON.parse(o)).NBest.map(e=>new M(e.Lexical,e.Confidence));let n=Array.from(s);for(let e=0;e<s.length;e++){const t=s[e];if(t.text.search(/^([a-zA-Z]\s)+[a-zA-Z]$/)>=0){const e=t.text.replace(/\s/g,""),i=.9*t.confidence;n.push(new M(e,i))}else if(t.text.search(/^([a-zA-Z]\s)+[a-zA-Z][a-zA-Z]+$/)>=0){let e=t.text.match(/^(([a-zA-Z]\s)+)([a-zA-Z][a-zA-Z]+)$/);if(e&&4==e.length){const i=e[1].replace(/\s/g,""),o=e[3],s=.85*t.confidence;n.push(new M(i+" "+o,s))}}}return i.results=n.sort((e,t)=>t.confidence-e.confidence),i}addTicksToDate(e,t){let i=1e4*e.getTime()+621355968e9;return new Date((i+t-621355968e9)/1e4)}}class A{constructor(){this.results=[],this.startTime=new Date,this.endTime=new Date}}class M{constructor(e,t){this.text=e,this.confidence=t}}class _{constructor(){this.RecognitionStatus="",this.Offset=0,this.Duration=0,this.DisplayText="",this.NBest=[]}}class D{constructor(e,t=50){this.symbol=e,this.size=t}asGeoJSON(){let e=this.symbol.asGeoJSON(),t=this.getGestureGeometry(this.symbol);e.geometry=t;let i=this.asSVG();return i&&(e.properties.rendering=i),e}asSVG(){if("point"==this.symbol.location?.fsTYPE){return[this.pointSVG(this.symbol)]}return null}getGestureGeometry(e){if(null==e.location||null==e.location||null==e.location.coords||0==e.location.coords.length||null==e.location.centroid)throw new Error("Symbol does not have location information");let t;if("point"==e.location.shape)t={type:"Point",coordinates:[e.location.centroid.lon,e.location.centroid.lat]};else if(t=this.toLineString(e.location.coords),null!=e.location?.shape&&e.location?.shape.includes("arrowfat")){let i=e.location.coords.slice(0,e.location.coords.length-1).reverse();i.push(e.location.coords[e.location.coords.length-1]),t=this.toLineString(i)}else if("ubend"==e.location?.shape){let i=[e.location.coords[0],e.location.coords[2],e.location.coords[3],e.location.coords[1]];t=this.toLineString(i)}else if("ubendthreepoints"==e.location?.shape){let i=new b(e.location.coords[1].lat,e.location.coords[2].lon),o=[e.location.coords[0],e.location.coords[2],i,e.location.coords[1]];t=this.toLineString(o)}else if("vee"==e.location?.shape){let i=[e.location.coords[1],e.location.coords[0],e.location.coords[2]];t=this.toLineString(i)}else"opencircle"==e.location?.shape||"multipoint"==e.location?.shape&&(t={type:"MultiPoint",coordinates:e.location.coords.map(e=>[e.lon,e.lat])});return t}pointSVG(e){if(null==e.location||null==e.location||null==e.location.centroid)throw new Error("Point symbol does not have a defined centroid");let t,i,o,s,n,r=0,a="";const l=1.42;if("friend"===e.affiliation)s=this.size-2,n=this.size/l-2,t="rect",i='width="'+s+'" height="'+n+'" ',o="#80e0ff";else if("hostile"===e.affiliation){let e=this.size/l-2;s=n=e*Math.SQRT2,t="rect",i='width="'+e+'" height="'+e+'" ',o="#ff8080",r=45,a='transform="translate('+s/2+" 0) rotate("+r+')" '}else"neutral"===e.affiliation?(s=n=this.size/l-2,t="rect",i='width="'+s+'" height="'+n+'" ',o="#aaffaa"):(s=n=this.size/l-2,t="circle",i='cx="'+s/2+'" cy="'+n/2+'" r="'+s/2+'" ',o="#ffff80");let c,d='<svg xmlns="http://www.w3.org/2000/svg" version="1.2" baseProfile="tiny" width="'+s+'" height="'+n+'" viewBox="0 0 '+s+" "+n+'" > <'+t+" "+i+' stroke="black" stoke-width="1" fill="'+o+'" '+a+"/></svg>";if(r>0){const e=this.getTransform(d,t);c=[this.applyTransform(e,{x:0,y:0}),this.applyTransform(e,{x:s,y:0}),this.applyTransform(e,{x:s,y:n}),this.applyTransform(e,{x:0,y:n})]}else c=[{x:0,y:0},{x:s,y:0},{x:s,y:n},{x:0,y:n}];return{type:"icon",title:e.description,topLeft:e.location.centroid,bottomRight:e.location.centroid,position:e.location.centroid,svg:btoa(d),shape:c,anchor:{x:s/2,y:n/2}}}getTransform(e,t){let i=document.createElement("div");document.body.appendChild(i),i.setAttribute("style","position:absolute; padding:0; margin:0;visibility:hidden; width:0; height:0"),i.insertAdjacentHTML("beforeend",e);let o=i.querySelector(t),s=o?.getCTM();return document.body.removeChild(i),s?[s.a,s.b,s.c,s.d,s.e,s.f]:[1,0,0,1,0,0]}toLineString(e){return{type:"LineString",coordinates:e.map(e=>[e.lon,e.lat])}}applyTransform(e,t){return{x:t.x*e[0]+t.y*e[2]+e[4],y:t.x*e[1]+t.y*e[3]+e[5]}}}function L(e,t,i,o){return new(i||(i=Promise))(function(t,s){function n(e){try{a(o.next(e))}catch(e){s(e)}}function r(e){try{a(o.throw(e))}catch(e){s(e)}}function a(e){var o;e.done?t(e.value):(o=e.value,o instanceof i?o:new i(function(e){e(o)})).then(n,r)}a((o=o.apply(e,[])).next())})}function U(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}"function"==typeof SuppressedError&&SuppressedError;var z=U(d?c:(d=1,c=function e(t,i){if(t===i)return!0;if(t&&i&&"object"==typeof t&&"object"==typeof i){if(t.constructor!==i.constructor)return!1;var o,s,n;if(Array.isArray(t)){if((o=t.length)!=i.length)return!1;for(s=o;0!==s--;)if(!e(t[s],i[s]))return!1;return!0}if(t.constructor===RegExp)return t.source===i.source&&t.flags===i.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===i.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===i.toString();if((o=(n=Object.keys(t)).length)!==Object.keys(i).length)return!1;for(s=o;0!==s--;)if(!Object.prototype.hasOwnProperty.call(i,n[s]))return!1;for(s=o;0!==s--;){var r=n[s];if(!e(t[r],i[r]))return!1}return!0}return t!=t&&i!=i}));const F="__googleMapsScriptId";var x;!function(e){e[e.INITIALIZED=0]="INITIALIZED",e[e.LOADING=1]="LOADING",e[e.SUCCESS=2]="SUCCESS",e[e.FAILURE=3]="FAILURE"}(x||(x={}));class N{constructor({apiKey:e,authReferrerPolicy:t,channel:i,client:o,id:s=F,language:n,libraries:r=[],mapIds:a,nonce:l,region:c,retries:d=3,url:h="https://maps.googleapis.com/maps/api/js",version:p}){if(this.callbacks=[],this.done=!1,this.loading=!1,this.errors=[],this.apiKey=e,this.authReferrerPolicy=t,this.channel=i,this.client=o,this.id=s||F,this.language=n,this.libraries=r,this.mapIds=a,this.nonce=l,this.region=c,this.retries=d,this.url=h,this.version=p,N.instance){if(!z(this.options,N.instance.options))throw new Error(`Loader must not be called again with different options. ${JSON.stringify(this.options)} !== ${JSON.stringify(N.instance.options)}`);return N.instance}N.instance=this}get options(){return{version:this.version,apiKey:this.apiKey,channel:this.channel,client:this.client,id:this.id,libraries:this.libraries,language:this.language,region:this.region,mapIds:this.mapIds,nonce:this.nonce,url:this.url,authReferrerPolicy:this.authReferrerPolicy}}get status(){return this.errors.length?x.FAILURE:this.done?x.SUCCESS:this.loading?x.LOADING:x.INITIALIZED}get failed(){return this.done&&!this.loading&&this.errors.length>=this.retries+1}createUrl(){let e=this.url;return e+="?callback=__googleMapsCallback&loading=async",this.apiKey&&(e+=`&key=${this.apiKey}`),this.channel&&(e+=`&channel=${this.channel}`),this.client&&(e+=`&client=${this.client}`),this.libraries.length>0&&(e+=`&libraries=${this.libraries.join(",")}`),this.language&&(e+=`&language=${this.language}`),this.region&&(e+=`&region=${this.region}`),this.version&&(e+=`&v=${this.version}`),this.mapIds&&(e+=`&map_ids=${this.mapIds.join(",")}`),this.authReferrerPolicy&&(e+=`&auth_referrer_policy=${this.authReferrerPolicy}`),e}deleteScript(){const e=document.getElementById(this.id);e&&e.remove()}load(){return this.loadPromise()}loadPromise(){return new Promise((e,t)=>{this.loadCallback(i=>{i?t(i.error):e(window.google)})})}importLibrary(e){return this.execute(),google.maps.importLibrary(e)}loadCallback(e){this.callbacks.push(e),this.execute()}setScript(){var e,t;if(document.getElementById(this.id))return void this.callback();const i={key:this.apiKey,channel:this.channel,client:this.client,libraries:this.libraries.length&&this.libraries,v:this.version,mapIds:this.mapIds,language:this.language,region:this.region,authReferrerPolicy:this.authReferrerPolicy};Object.keys(i).forEach(e=>!i[e]&&delete i[e]),(null===(t=null===(e=null===window||void 0===window?void 0:window.google)||void 0===e?void 0:e.maps)||void 0===t?void 0:t.importLibrary)||(e=>{let t,i,o,s="The Google Maps JavaScript API",n="google",r="importLibrary",a="__ib__",l=document,c=window;c=c[n]||(c[n]={});const d=c.maps||(c.maps={}),h=new Set,p=new URLSearchParams,u=()=>t||(t=new Promise((r,c)=>L(this,0,void 0,function*(){var u;for(o in yield i=l.createElement("script"),i.id=this.id,p.set("libraries",[...h]+""),e)p.set(o.replace(/[A-Z]/g,e=>"_"+e[0].toLowerCase()),e[o]);p.set("callback",n+".maps."+a),i.src=this.url+"?"+p,d[a]=r,i.onerror=()=>t=c(Error(s+" could not load.")),i.nonce=this.nonce||(null===(u=l.querySelector("script[nonce]"))||void 0===u?void 0:u.nonce)||"",l.head.append(i)})));d[r]?console.warn(s+" only loads once. Ignoring:",e):d[r]=(e,...t)=>h.add(e)&&u().then(()=>d[r](e,...t))})(i);const o=this.libraries.map(e=>this.importLibrary(e));o.length||o.push(this.importLibrary("core")),Promise.all(o).then(()=>this.callback(),e=>{const t=new ErrorEvent("error",{error:e});this.loadErrorCallback(t)})}reset(){this.deleteScript(),this.done=!1,this.loading=!1,this.errors=[],this.onerrorEvent=null}resetIfRetryingFailed(){this.failed&&this.reset()}loadErrorCallback(e){if(this.errors.push(e),this.errors.length<=this.retries){const e=this.errors.length*Math.pow(2,this.errors.length);console.error(`Failed to load Google Maps script, retrying in ${e} ms.`),setTimeout(()=>{this.deleteScript(),this.setScript()},e)}else this.onerrorEvent=e,this.callback()}callback(){this.done=!0,this.loading=!1,this.callbacks.forEach(e=>{e(this.onerrorEvent)}),this.callbacks=[]}execute(){if(this.resetIfRetryingFailed(),!this.loading)if(this.done)this.callback();else{if(window.google&&window.google.maps&&window.google.maps.version)return console.warn("Google Maps already loaded outside @googlemaps/js-api-loader. This may result in undesirable behavior as options and script parameters may not match."),void this.callback();this.loading=!0,this.setScript()}}}class q{constructor(e,t,i,o){this.load=async()=>{new N({apiKey:this.apiKey,version:"weekly"}).loadCallback(async e=>{if(e)throw console.log(e),new Error(e.message);await this.initMap()})},this.apiKey=e,this.mapDivId=t,this.mapCenter=i,this.zoomLevel=o,this.strokeStart=this.strokeEnd="",this.assets=new Map}async initMap(){const e=document.getElementById(this.mapDivId);if(!e)throw new Error("Html page must contain a 'map' div");const{Map:t}=await google.maps.importLibrary("maps");this.map=new t(e,{zoom:this.zoomLevel,center:{lat:this.mapCenter.lat,lng:this.mapCenter.lon},gestureHandling:"cooperative",draggable:!0,draggableCursor:"crosshair"}),this.map.data.setStyle(e=>{let t=e.getProperty("rendering");if(t){for(let i=0;i<t.length;i++){const o={type:"poly",coords:t[i].shape.flatMap(e=>[e.x,e.y])};let s=new google.maps.Marker({map:this.map,icon:{url:"data:image/svg+xml;charset=UTF-8;base64,"+t[i].svg,anchor:new google.maps.Point(t[i].anchor.x,t[i].anchor.y)},shape:o,position:{lat:t[i].position.lat,lng:t[i].position.lon}});t[i].title&&s.setTitle(t[i].title),s.addListener("click",()=>{this.onSelection?.call(this,e.getProperty("symbol"))});let n=e.getProperty("symbol")?.poid;n&&(this.assets.has(n)?this.assets.get(n).push(s):this.assets.set(n,[s]))}return{visible:"Point"!=e.getGeometry().getType()}}return{visible:!0}}),this.map.data.addListener("click",e=>{this.onSelection?.call(this,e.feature.getProperty("symbol"))}),this.map.addListener("mousedown",e=>{if(e.domEvent.ctrlKey)return!1;e.domEvent.preventDefault(),this.enableDrawing(),this.onStrokeStart?.call(this,new b(e.latLng.lat(),e.latLng.lng()),this.getIsoTimestamp()),this.drawFreeHand(e.latLng)})}drawFreeHand(e){this.strokeStart=this.getIsoTimestamp(),this.clearInk(),this.strokePoly=new google.maps.Polyline({map:this.map,clickable:!1,strokeColor:"#8B0000",strokeWeight:2}),this.strokePoly.getPath().push(e),this.moveListener=google.maps.event.addListener(this.map,"mousemove",e=>{this.strokePoly.getPath().push(e.latLng)}),google.maps.event.addListenerOnce(this.map,"mouseup",e=>{this.strokeEnd=this.getIsoTimestamp(),this.moveListener&&google.maps.event.removeListener(this.moveListener),this.enableDragZoom();let t=this.strokePoly.getPath();1==t.getLength()&&t.push(t.getAt(0));let i=t.getArray().map(e=>new b(e.lat(),e.lng())),o={width:document.getElementById("map").clientWidth,height:document.getElementById("map").clientHeight},s=this.map.getBounds();if(!s)throw new Error("Failed to retrieve the map bounds - unable to send ink to STP");this.onStrokeCompleted&&this.onStrokeCompleted(new v(o.width,o.height),new b(s.getNorthEast().lat(),s.getSouthWest().lng()),new b(s.getSouthWest().lat(),s.getNorthEast().lng()),i,this.strokeStart,this.strokeEnd,[])})}enableDrawing(){this.map.setOptions({draggable:!1,zoomControl:!1,scrollwheel:!1,disableDoubleClickZoom:!1})}enableDragZoom(){this.map.setOptions({draggable:!0,zoomControl:!0,scrollwheel:!0,disableDoubleClickZoom:!0})}addFeature(e){e&&this.map.data.addGeoJson(e)}removeFeature(e){let t=this.map.data.getFeatureById(e);if(t){if(this.assets.has(e)){let t=this.assets.get(e);for(let e=0;e<t.length;e++)t[e].setMap(null)}this.map.data.remove(t)}}displayInfo(e,t,i){let o=document.createElement("div");o.innerHTML=e;let s={lat:t.lat,lng:t.lon},n=new google.maps.InfoWindow({content:o,position:s});if(n&&i&&i.length)for(let e=0;e<i.length;e++){let t=o.querySelector(i[e].selector);t&&i[e].handler&&t.addEventListener("click",t=>{i[e].closeInfo&&n.close(),i[e].handler(t)})}n.open(this.map)}clearInk(){this.strokePoly?.setMap(null)}getBounds(){return this.map.getBounds()}getIsoTimestamp(){return(new Date).toISOString()}}let G,j,B="<Enter your Azure Speech subscription key here>",W="<Enter Azure's subscription region>",H=null,J="<Enter your Google Maps API key here>",Z=new b(58.967774948,11.196062412),$=13,K="ws://<STP server>:<STP port>";function Y(e,t,i){i&&alert(e);let o=document.getElementById("messages");if(!o)throw new Error("Html page must contain a 'messages' div");o.innerHTML=e,o.style.color="Error"===t?"red":"black"}window.onload=()=>async function(){const e=new URLSearchParams(window.location.search),t=e.get("mapkey");t&&(J=t);const o=e.get("lat"),s=e.get("lon");o&&s&&(Z=new b(parseFloat(o),parseFloat(s)));const n=e.get("zoom");n&&($=parseInt(n));const r=e.get("azkey");r&&(B=r);const a=e.get("azregion");a&&(W=a);e.get("azlang");const l=e.get("azendp");l&&(H=l);const c=e.get("stpurl");c&&(K=c);const d=new I(K);G=new O(d),G.onSymbolAdded=(e,t)=>{let i=new D(e[0]).asGeoJSON();j.addFeature(i)},G.onSymbolModified=(e,t,i)=>{j.removeFeature(e);let o=new D(t).asGeoJSON();j.addFeature(o)},G.onSymbolDeleted=(e,t)=>{j.removeFeature(e)},G.onInkProcessed=()=>{j.clearInk()},G.onSpeechRecognized=e=>{let t="";e&&e.length>0&&(t=e[0]),Y(t)},G.onStpMessage=(e,t)=>{Y(e,t,!0)};try{await G.connect("GoogleMapsSample",10)}catch(e){return void Y("Failed to connect to STP at "+K+". \nSymbols will not be recognized. Please reload to try again",i.Error,!0)}j=new q(J,"map",Z,$),j.onStrokeStart=(e,t)=>{G.sendPenDown(e,t),async function(){try{const e=new R(B,W,H);let t=await e.recognizeOnce();t&&(G.sendSpeechRecognition(t.results,t.startTime,t.endTime),t.results&&t.results.length>0&&Y(t.results[0].text))}catch(e){Y("Failed to process speech: "+e.message)}}()},j.onStrokeCompleted=(e,t,i,o,s,n,r)=>{G.sendInk(e,t,i,o,s,n,r)},j.onSelection=e=>{let t=function(e){if(!e||!e.location||!e.location.centroid)return null;let t='<h3 id="firstHeading" class="firstHeading">'+e.fullDescription+"</h3><table><tr><td>2525D PartA</td><td>"+e.sidc?.partA+"</td></tr><tr><td>2525D PartB</td><td>"+e.sidc?.partB+"</td></tr><tr><td>Symbol Set</td><td>"+e.sidc?.symbolSet+"</td></tr><tr><td>2525C SIDC</td><td>"+e.sidc?.legacy+"</td></tr><tr><td>Affiliation</td><td>"+e.affiliation+"</td></tr>";"unit"==e.fsTYPE&&(t+="<tr><td>Echelon</td><td>"+e.echelon+"</td></tr>");t+="<tr><td>Parent Unit</td><td>"+e.parent+"</td></tr><tr><td>Designator 1</td><td>"+e.designator1+"</td></tr><tr><td>Designator 2</td><td>"+e.designator2+"</td></tr><tr><td>Status</td><td>"+e.status+"</td></tr>","unit"==e.fsTYPE&&(t+="<tr><td>Modifier</td><td>"+e.modifier+"</td></tr><tr><td>Strength</td><td>"+e.strength+"</td></tr>");return t+="<tr><td>Time From</td><td>"+e.timeFrom+"</td></tr><tr><td>Time To</td><td>"+e.timeTo+"</td></tr><tr><td>Altitude</td><td>"+e.altitude+"</td></tr><tr><td>Min Altitude</td><td>"+e.minAltitude+"</td></tr><tr><td>Max Altitude</td><td>"+e.maxAltitude+'</td></tr><tr><td><button id="delButton">Delete</button></td></tr></table>',t}(e);t&&e&&e.poid&&e.location&&e.location.centroid&&j.displayInfo(t,e.location.centroid,[{selector:"#delButton",handler:t=>{G.deleteSymbol(e.poid)},closeInfo:!0}])},j.load()}()}(SpeechSDK);