!function(t){function e(t,i){let n,s=t&&t.type;if("FeatureCollection"===s){let o=t;for(n=0;n<o.features.length;n++)e(o.features[n],i)}else if("GeometryCollection"===s){let o=t;for(n=0;n<o.geometries.length;n++)e(o.geometries[n],i)}else if("Feature"===s){e(t.geometry,i)}else if("Polygon"===s){o(t.coordinates,i)}else if("MultiPolygon"===s){let e=t;for(n=0;n<e.coordinates.length;n++)o(e.coordinates[n],i)}return t}function o(t,e){if(0!==t.length){i(t[0],e);for(let o=1;o<t.length;o++)i(t[o],!e)}}function i(t,e){let o=0;for(let e=0,i=t.length,n=i-1;e<i;n=e++)o+=(t[e][0]-t[n][0])*(t[n][1]+t[e][1]);o>=0!=!!e&&t.reverse()}var n;!function(t){t.Error="Error",t.Warning="Warning",t.Info="Info",t.Debug="Debug"}(n||(n={}));class s{}class r extends s{asGeoJSON(){var t,o,i,n,s,r;if(null==this.location||null==this.location.coords||0==(null===(t=this.location)||void 0===t?void 0:t.coords.length))throw new Error("Coordinates are undefined or empty");let a;if("point"===(null===(o=this.location)||void 0===o?void 0:o.fsTYPE))a={type:"Point",coordinates:[this.location.coords[0].lon,this.location.coords[0].lat]};else if("line"===(null===(i=this.location)||void 0===i?void 0:i.fsTYPE))a={type:"LineString",coordinates:this.location.coords.map((t=>[t.lon,t.lat]))};else if("area"===(null===(n=this.location)||void 0===n?void 0:n.fsTYPE))a={type:"Polygon",coordinates:[this.location.coords.map((t=>[t.lon,t.lat]))]},a=e(a,!1);else{if("multipoint"!==(null===(s=this.location)||void 0===s?void 0:s.fsTYPE))throw new Error('Expected "point", "line", "area", or "multipoint" geometry type. Got: '+(null===(r=this.location)||void 0===r?void 0:r.fsTYPE));a={type:"MultiPoint",coordinates:this.location.coords.map((t=>[t.lon,t.lat]))}}return{type:"Feature",id:this.poid,geometry:a,properties:{symbol:this}}}}class a{constructor(t,e){this.lat=t,this.lon=e}equals(t){return this.lat==t.lat&&this.lon==t.lon}}class l{constructor(t,e){this.width=t,this.height=e}equals(t){return this.width==t.width&&this.height==t.height}}var c=function(t,e,o,i){return new(o||(o=Promise))((function(n,s){function r(t){try{l(i.next(t))}catch(t){s(t)}}function a(t){try{l(i.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof o?e:new o((function(t){t(e)}))).then(r,a)}l((i=i.apply(t,e||[])).next())}))};class h{constructor(t){this.stpConnector=t,this.serviceName=""}connect(t,e,o){return c(this,void 0,void 0,(function*(){this.serviceName=t,this.stpConnector.onInform=this.onInform.bind(this),this.stpConnector.onRequest=this.onRequest.bind(this),this.stpConnector.onError=this.onError.bind(this);try{let t=this.buildSolvables();return this.stpConnector.connect(this.serviceName,t,e,o)}catch(t){throw t}}))}buildSolvables(){return Object.getOwnPropertyNames(this).filter((t=>t.toString().startsWith("on")&&"function"==typeof this[t])).map((t=>t.substring(2)))}onInform(t){let e=JSON.parse(t);this.handleInform(e)}onRequest(t){return this.onInform(t),[]}onError(t){this.onStpMessage&&this.onStpMessage(t,n.Error)}sendPenDown(t,e){return c(this,arguments,void 0,(function*(){this.informStp("SendPenDown",{location:arguments[0],timestamp:arguments[1]})}))}sendInk(t,e,o,i,n,s,r){this.informStp("SendInk",{pixelBoundsWindow:arguments[0],topLeftGeoMap:arguments[1],bottomRightGeoMap:arguments[2],strokePoints:arguments[3],timeStrokeStart:arguments[4],timeStrokeEnd:arguments[5],intersectedPoids:arguments[6]})}sendSpeechRecognition(t,e,o){this.informStp("SendSpeechRecognition",{recoList:arguments[0],startTime:arguments[1],endTime:arguments[2]})}addSymbol(t){this.informStp("AddSymbol",{symbol:arguments[0]})}updateSymbol(t,e){this.informStp("UpdateSymbol",{poid:arguments[0],symbol:arguments[1]})}deleteSymbol(t){this.informStp("DeleteSymbol",{poid:arguments[0]})}chooseAlternate(t,e){this.informStp("ChooseAlternate",{poid:arguments[0],nBestIndex:arguments[1]})}informStp(t,e){try{let o={method:t,params:e};this.stpConnector.inform(JSON.stringify(o))}catch(t){this.onStpMessage&&this.onStpMessage(t.message,n.Error)}}handleInform(t){if("SymbolAdded"===t.method&&this.onSymbolAdded){const e=t.params;let o=[];for(let t=0;t<e.alternates.length;t++){const i=Object.assign(new r,e.alternates[t]);o.push(i)}this.onSymbolAdded(o,e.isUndo)}else if("SymbolModified"===t.method&&this.onSymbolModified){const e=t.params,o=Object.assign(new r,e.symbol);this.onSymbolModified(e.poid,o,e.isUndo)}else if("SymbolDeleted"===t.method&&this.onSymbolDeleted){const e=t.params;this.onSymbolDeleted(e.poid,e.isUndo)}else if("InkProcessed"===t.method&&this.onInkProcessed)this.onInkProcessed();else if("SpeechRecognized"===t.method&&this.onSpeechRecognized){const e=t.params;this.onSpeechRecognized(e.phrases)}else if("StpMessage"===t.method&&this.onStpMessage){const e=t.params;this.onStpMessage(e.message,e.level)}else console.log("Received message with no handler: "+t.method)}}var d=function(t,e,o,i){return new(o||(o=Promise))((function(n,s){function r(t){try{l(i.next(t))}catch(t){s(t)}}function a(t){try{l(i.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof o?e:new o((function(t){t(e)}))).then(r,a)}l((i=i.apply(t,e||[])).next())}))};class u{constructor(t){this.DEFAULT_TIMEOUT=30,this.connstring=t,this.socket=null}get isConnected(){return null!=this.socket&&this.socket.readyState===this.socket.OPEN}get isConnecting(){return null!=this.socket&&this.socket.readyState===this.socket.CONNECTING}get connState(){return this.socket?this.socket.readyState.toString():""}connect(t,e,o=this.DEFAULT_TIMEOUT,i=null){return d(this,void 0,void 0,(function*(){return new Promise(((n,s)=>d(this,void 0,void 0,(function*(){this.isConnected&&n(),this.serviceName=t,this.solvables=e,null!=i&&(this.machineId=i),o<=0&&(o=this.DEFAULT_TIMEOUT);try{this.socket=yield this.promiseWithTimeout(o,this.tryConnect(this.connstring)),yield this.register()}catch(t){return void s(new Error("Failed to connect: "+t.message))}this.socket.onmessage=t=>{this.onInform&&this.onInform(t.data)},this.socket.onerror=t=>{this.onError&&this.onError("Error connecting to STP. Check that the service is running and refresh page to retry")},this.socket.onclose=t=>d(this,void 0,void 0,(function*(){if(!this.isConnecting)try{yield this.connect(this.serviceName,this.solvables,this.timeout,this.machineId)}catch(t){this.onError&&this.onError("Lost connection to STP. Check that the service is running and refresh page to retry")}})),n()}))))}))}register(){if(!this.isConnected)throw new Error("Failed to register: connection is not open ("+this.connState+")");return this.promiseWithTimeout(this.timeout||this.DEFAULT_TIMEOUT,new Promise(((t,e)=>d(this,void 0,void 0,(function*(){this.socket&&(this.name=this.serviceName,this.socket.send(JSON.stringify({method:"Register",params:{serviceName:this.name,language:"javascript",solvables:this.solvables,machineId:this.machineId||this.getUniqueId(9)}})),t())})))))}disconnect(t=this.DEFAULT_TIMEOUT){return this.promiseWithTimeout(t,new Promise(((t,e)=>d(this,void 0,void 0,(function*(){!this.isConnected&&this.socket&&this.socket.close(),t()})))))}inform(t,e=this.DEFAULT_TIMEOUT){if(!this.isConnected)throw new Error("Failed to send inform: connection is not open ("+this.connState+")");return this.promiseWithTimeout(e,new Promise(((e,o)=>d(this,void 0,void 0,(function*(){this.socket&&(this.socket.send(t),e())})))))}request(t,e=this.DEFAULT_TIMEOUT){throw new Error("Method not implemented")}tryConnect(t){return new Promise(((e,o)=>{var i=new WebSocket(t);i.onopen=()=>e(i),i.onerror=t=>o(new Error("Unspecified error communicating with STP"))}))}promiseWithTimeout(t,e){return Promise.race([e,new Promise(((e,o)=>{let i=setTimeout((()=>{clearTimeout(i),o(new Error("Operation timed out"))}),1e3*t)}))])}getUniqueId(t){return t||(t=9),Math.random().toString(36).substr(2,t)}}var g={exports:{}};(function(t,e){class o{constructor(){this.results=[],this.startTime=new Date,this.endTime=new Date}}class i{constructor(t,e){this.text=t,this.confidence=e}}class n{constructor(){this.RecognitionStatus="",this.Offset=0,this.Duration=0,this.DisplayText="",this.NBest=[]}}t.AzureSpeechRecognizer=class{constructor(t,o,i,n){this.speechSubscriptionKey=t,this.serviceRegion=o,this.speechConfig=e.SpeechConfig.fromSubscription(this.speechSubscriptionKey,this.serviceRegion),this.speechConfig.outputFormat=e.OutputFormat.Detailed,i&&(this.speechConfig.endpointId=i),this.audioConfig=n||e.AudioConfig.fromDefaultMicrophoneInput()}recognizeOnce(t){return t||(t=8),this.recognizer=new e.SpeechRecognizer(this.speechConfig,this.audioConfig),new Promise(((e,o)=>function(t,e,o,i){return new(o||(o=Promise))((function(n,s){function r(t){try{l(i.next(t))}catch(t){s(t)}}function a(t){try{l(i.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof o?e:new o((function(t){t(e)}))).then(r,a)}l((i=i.apply(t,e||[])).next())}))}(this,void 0,void 0,(function*(){var i;for(let o=0;o<t;o++){this.recoStart=new Date;try{const t=yield this.tryReco(this.recoStart);return void e(t)}catch(t){}o<t-1&&(yield new Promise((t=>setTimeout(t,250))))}let n=new Error("Failed to recognize speech");null===(i=this.onError)||void 0===i||i.call(this,n),o(n)}))))}tryReco(t){return new Promise(((o,i)=>{var n;this.recognizer.recognizing=(t,e)=>{var o;null===(o=this.onRecognizing)||void 0===o||o.call(this,e.result.text)},this.recognizer.recognized=(e,i)=>{var n;let s=this.convertResults(t,i.result);null===(n=this.onRecognized)||void 0===n||n.call(this,s),o(s)},this.recognizer.canceled=(t,o)=>{i(new Error(e.CancellationReason[o.reason]))},null===(n=this.recognizer)||void 0===n||n.recognizeOnceAsync()}))}startRecognizing(){this.recognizer=new e.SpeechRecognizer(this.speechConfig,this.audioConfig),this.recoStart=new Date,this.recognizer.recognizing=(t,e)=>{var o;null===(o=this.onRecognizing)||void 0===o||o.call(this,e.result.text)},this.recognizer.recognized=(t,e)=>{var o;let i=this.convertResults(this.recoStart,e.result);null===(o=this.onRecognized)||void 0===o||o.call(this,i)},this.recognizer.canceled=(t,o)=>{var i;let n=new Error(e.CancellationReason[o.reason]);this.onError?this.onError.call(this,n):null===(i=this.onRecognized)||void 0===i||i.call(this,null)},this.recognizer.startContinuousRecognitionAsync()}stopRecognizing(t){this.recognizer&&setTimeout((()=>{var t;null===(t=this.recognizer)||void 0===t||t.close(),this.recognizer=void 0}),t||0)}convertResults(t,s){if(s.reason===e.ResultReason.NoMatch)return null;let r=new o;r.startTime=this.addTicksToDate(t,s.offset),r.endTime=this.addTicksToDate(r.startTime,s.duration);let a=s.properties.getProperty(e.PropertyId.SpeechServiceResponse_JsonResult);const l=Object.assign(new n,JSON.parse(a)).NBest.map((t=>new i(t.Lexical,t.Confidence)));let c=Array.from(l);for(let t=0;t<l.length;t++){const e=l[t];if(e.text.search(/^([a-zA-Z]\s)+[a-zA-Z]$/)>=0){const t=e.text.replace(/\s/g,""),o=.9*e.confidence;c.push(new i(t,o))}else if(e.text.search(/^([a-zA-Z]\s)+[a-zA-Z]+$/)>=0){let t=e.text.match(/^(([a-zA-Z]\s)+)([a-zA-Z]+)$/);if(t&&4==t.length){const o=t[1].replace(/\s/g,""),n=t[3],s=.7*e.confidence;c.push(new i(o+" "+n,s))}}}return r.results=c.sort(((t,e)=>e.confidence-t.confidence)),r}addTicksToDate(t,e){let o=1e4*t.getTime()+621355968e9;return new Date((o+e-621355968e9)/1e4)}},Object.defineProperty(t,"__esModule",{value:!0})})(g.exports,t);var p=g.exports;class m{constructor(t,e=50){this.symbol=t,this.size=e}asGeoJSON(){let t=this.symbol.asGeoJSON(),e=this.getGestureGeometry(this.symbol);t.geometry=e;let o=this.asSVG();return o&&(t.properties.rendering=o),t}asSVG(){if("point"==this.symbol.location?.fsTYPE){return[this.pointSVG(this.symbol)]}return null}getGestureGeometry(t){if(null==t.location||null==t.location||null==t.location.coords||0==t.location.coords.length||null==t.location.centroid)throw new Error("Symbol does not have location information");let e;if("point"==t.location.shape)e={type:"Point",coordinates:[t.location.centroid.lon,t.location.centroid.lat]};else if(e=this.toLineString(t.location.coords),null!=t.location?.shape&&t.location?.shape.includes("arrowfat")){let o=t.location.coords.slice(0,t.location.coords.length-1).reverse();o.push(t.location.coords[t.location.coords.length-1]),e=this.toLineString(o)}else if("ubend"==t.location?.shape){let o=[t.location.coords[0],t.location.coords[2],t.location.coords[3],t.location.coords[1]];e=this.toLineString(o)}else if("ubendthreepoints"==t.location?.shape){let o=new a(t.location.coords[1].lat,t.location.coords[2].lon),i=[t.location.coords[0],t.location.coords[2],o,t.location.coords[1]];e=this.toLineString(i)}else if("vee"==t.location?.shape){let o=[t.location.coords[1],t.location.coords[0],t.location.coords[2]];e=this.toLineString(o)}else"opencircle"==t.location?.shape||"multipoint"==t.location?.shape&&(e={type:"MultiPoint",coordinates:t.location.coords.map((t=>[t.lon,t.lat]))});return e}pointSVG(t){if(null==t.location||null==t.location||null==t.location.centroid)throw new Error("Point symbol does not have a defined centroid");let e,o,i,n,s,r=0,a="";const l=1.42;if("friend"===t.affiliation)n=this.size-2,s=this.size/l-2,e="rect",o='width="'+n+'" height="'+s+'" ',i="#80e0ff";else if("hostile"===t.affiliation){let t=this.size/l-2;n=s=t*Math.SQRT2,e="rect",o='width="'+t+'" height="'+t+'" ',i="#ff8080",r=45,a='transform="translate('+n/2+" 0) rotate("+r+')" '}else"neutral"===t.affiliation?(n=s=this.size/l-2,e="rect",o='width="'+n+'" height="'+s+'" ',i="#aaffaa"):(n=s=this.size/l-2,e="circle",o='cx="'+n/2+'" cy="'+s/2+'" r="'+n/2+'" ',i="#ffff80");let c,h='<svg xmlns="http://www.w3.org/2000/svg" version="1.2" baseProfile="tiny" width="'+n+'" height="'+s+'" viewBox="0 0 '+n+" "+s+'" > <'+e+" "+o+' stroke="black" stoke-width="1" fill="'+i+'" '+a+"/></svg>";if(r>0){const t=this.getTransform(h,e);c=[this.applyTransform(t,{x:0,y:0}),this.applyTransform(t,{x:n,y:0}),this.applyTransform(t,{x:n,y:s}),this.applyTransform(t,{x:0,y:s})]}else c=[{x:0,y:0},{x:n,y:0},{x:n,y:s},{x:0,y:s}];return{type:"icon",title:t.description,topLeft:t.location.centroid,bottomRight:t.location.centroid,position:t.location.centroid,svg:btoa(h),shape:c,anchor:{x:n/2,y:s/2}}}getTransform(t,e){let o=document.createElement("div");document.body.appendChild(o),o.setAttribute("style","position:absolute; padding:0; margin:0;visibility:hidden; width:0; height:0"),o.insertAdjacentHTML("beforeend",t);let i=o.querySelector(e),n=i?.getCTM();return document.body.removeChild(o),n?[n.a,n.b,n.c,n.d,n.e,n.f]:[1,0,0,1,0,0]}toLineString(t){return{type:"LineString",coordinates:t.map((t=>[t.lon,t.lat]))}}applyTransform(t,e){return{x:e.x*t[0]+e.y*t[2]+t[4],y:e.x*t[1]+e.y*t[3]+t[5]}}}
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */function f(t,e,o,i){return new(o||(o=Promise))((function(n,s){function r(t){try{l(i.next(t))}catch(t){s(t)}}function a(t){try{l(i.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof o?e:new o((function(t){t(e)}))).then(r,a)}l((i=i.apply(t,e||[])).next())}))}var y=function t(e,o){if(e===o)return!0;if(e&&o&&"object"==typeof e&&"object"==typeof o){if(e.constructor!==o.constructor)return!1;var i,n,s;if(Array.isArray(e)){if((i=e.length)!=o.length)return!1;for(n=i;0!=n--;)if(!t(e[n],o[n]))return!1;return!0}if(e.constructor===RegExp)return e.source===o.source&&e.flags===o.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===o.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===o.toString();if((i=(s=Object.keys(e)).length)!==Object.keys(o).length)return!1;for(n=i;0!=n--;)if(!Object.prototype.hasOwnProperty.call(o,s[n]))return!1;for(n=i;0!=n--;){var r=s[n];if(!t(e[r],o[r]))return!1}return!0}return e!=e&&o!=o};const v="__googleMapsScriptId";var S;!function(t){t[t.INITIALIZED=0]="INITIALIZED",t[t.LOADING=1]="LOADING",t[t.SUCCESS=2]="SUCCESS",t[t.FAILURE=3]="FAILURE"}(S||(S={}));class w{constructor({apiKey:t,authReferrerPolicy:e,channel:o,client:i,id:n=v,language:s,libraries:r=[],mapIds:a,nonce:l,region:c,retries:h=3,url:d="https://maps.googleapis.com/maps/api/js",version:u}){if(this.callbacks=[],this.done=!1,this.loading=!1,this.errors=[],this.apiKey=t,this.authReferrerPolicy=e,this.channel=o,this.client=i,this.id=n||v,this.language=s,this.libraries=r,this.mapIds=a,this.nonce=l,this.region=c,this.retries=h,this.url=d,this.version=u,w.instance){if(!y(this.options,w.instance.options))throw new Error(`Loader must not be called again with different options. ${JSON.stringify(this.options)} !== ${JSON.stringify(w.instance.options)}`);return w.instance}w.instance=this}get options(){return{version:this.version,apiKey:this.apiKey,channel:this.channel,client:this.client,id:this.id,libraries:this.libraries,language:this.language,region:this.region,mapIds:this.mapIds,nonce:this.nonce,url:this.url,authReferrerPolicy:this.authReferrerPolicy}}get status(){return this.errors.length?S.FAILURE:this.done?S.SUCCESS:this.loading?S.LOADING:S.INITIALIZED}get failed(){return this.done&&!this.loading&&this.errors.length>=this.retries+1}createUrl(){let t=this.url;return t+="?callback=__googleMapsCallback",this.apiKey&&(t+=`&key=${this.apiKey}`),this.channel&&(t+=`&channel=${this.channel}`),this.client&&(t+=`&client=${this.client}`),this.libraries.length>0&&(t+=`&libraries=${this.libraries.join(",")}`),this.language&&(t+=`&language=${this.language}`),this.region&&(t+=`&region=${this.region}`),this.version&&(t+=`&v=${this.version}`),this.mapIds&&(t+=`&map_ids=${this.mapIds.join(",")}`),this.authReferrerPolicy&&(t+=`&auth_referrer_policy=${this.authReferrerPolicy}`),t}deleteScript(){const t=document.getElementById(this.id);t&&t.remove()}load(){return this.loadPromise()}loadPromise(){return new Promise(((t,e)=>{this.loadCallback((o=>{o?e(o.error):t(window.google)}))}))}importLibrary(t){return this.execute(),google.maps.importLibrary(t)}loadCallback(t){this.callbacks.push(t),this.execute()}setScript(){var t,e;if(document.getElementById(this.id))return void this.callback();const o={key:this.apiKey,channel:this.channel,client:this.client,libraries:this.libraries.length&&this.libraries,v:this.version,mapIds:this.mapIds,language:this.language,region:this.region,authReferrerPolicy:this.authReferrerPolicy};Object.keys(o).forEach((t=>!o[t]&&delete o[t])),(null===(e=null===(t=null===window||void 0===window?void 0:window.google)||void 0===t?void 0:t.maps)||void 0===e?void 0:e.importLibrary)||(t=>{let e,o,i,n="The Google Maps JavaScript API",s="google",r="importLibrary",a="__ib__",l=document,c=window;c=c[s]||(c[s]={});const h=c.maps||(c.maps={}),d=new Set,u=new URLSearchParams,g=()=>e||(e=new Promise(((r,c)=>f(this,void 0,void 0,(function*(){var g;for(i in yield o=l.createElement("script"),o.id=this.id,u.set("libraries",[...d]+""),t)u.set(i.replace(/[A-Z]/g,(t=>"_"+t[0].toLowerCase())),t[i]);u.set("callback",s+".maps."+a),o.src=this.url+"?"+u,h[a]=r,o.onerror=()=>e=c(Error(n+" could not load.")),o.nonce=this.nonce||(null===(g=l.querySelector("script[nonce]"))||void 0===g?void 0:g.nonce)||"",l.head.append(o)})))));h[r]?console.warn(n+" only loads once. Ignoring:",t):h[r]=(t,...e)=>d.add(t)&&g().then((()=>h[r](t,...e)))})(o);const i=this.libraries.map((t=>this.importLibrary(t)));i.length||i.push(this.importLibrary("core")),Promise.all(i).then((()=>this.callback()),(t=>{const e=new ErrorEvent("error",{error:t});this.loadErrorCallback(e)}))}reset(){this.deleteScript(),this.done=!1,this.loading=!1,this.errors=[],this.onerrorEvent=null}resetIfRetryingFailed(){this.failed&&this.reset()}loadErrorCallback(t){if(this.errors.push(t),this.errors.length<=this.retries){const t=this.errors.length*Math.pow(2,this.errors.length);console.error(`Failed to load Google Maps script, retrying in ${t} ms.`),setTimeout((()=>{this.deleteScript(),this.setScript()}),t)}else this.onerrorEvent=t,this.callback()}callback(){this.done=!0,this.loading=!1,this.callbacks.forEach((t=>{t(this.onerrorEvent)})),this.callbacks=[]}execute(){if(this.resetIfRetryingFailed(),this.done)this.callback();else{if(window.google&&window.google.maps&&window.google.maps.version)return console.warn("Google Maps already loaded outside @googlemaps/js-api-loader.This may result in undesirable behavior as options and script parameters may not match."),void this.callback();this.loading||(this.loading=!0,this.setScript())}}}class b{constructor(t,e,o,i){this.load=async()=>{new w({apiKey:this.apiKey,version:"weekly"}).loadCallback((async t=>{if(t)throw console.log(t),new Error(t.message);await this.initMap()}))},this.apiKey=t,this.mapDivId=e,this.mapCenter=o,this.zoomLevel=i,this.strokeStart=this.strokeEnd="",this.assets=new Map}async initMap(){const t=document.getElementById(this.mapDivId);if(!t)throw new Error("Html page must contain a 'map' div");const{Map:e}=await google.maps.importLibrary("maps");this.map=new e(t,{zoom:this.zoomLevel,center:{lat:this.mapCenter.lat,lng:this.mapCenter.lon},gestureHandling:"cooperative",draggable:!0,draggableCursor:"crosshair"}),this.map.data.setStyle((t=>{let e=t.getProperty("rendering");if(e){for(let o=0;o<e.length;o++){let i=e[o].shape.map((t=>[t.x,t.y])).flat(),n=new google.maps.Marker({map:this.map,icon:{url:"data:image/svg+xml;charset=UTF-8;base64,"+e[o].svg,anchor:new google.maps.Point(e[o].anchor.x,e[o].anchor.y)},shape:{type:"poly",coords:i},position:{lat:e[o].position.lat,lng:e[o].position.lon}});e[o].title&&n.setTitle(e[o].title),n.addListener("click",(()=>{this.onSelection?.call(this,t.getProperty("symbol"))}));let s=t.getProperty("symbol")?.poid;s&&(this.assets.has(s)?this.assets.get(s).push(n):this.assets.set(s,[n]))}return{visible:"Point"!=t.getGeometry().getType()}}return{visible:!0}})),this.map.data.addListener("click",(t=>{this.onSelection?.call(this,t.feature.getProperty("symbol"))})),this.map.addListener("mousedown",(t=>{if(t.domEvent.ctrlKey)return!1;t.domEvent.preventDefault(),this.enableDrawing(),this.onStrokeStart?.call(this,new a(t.latLng.lat(),t.latLng.lng()),this.getIsoTimestamp()),this.drawFreeHand(t.latLng)}))}drawFreeHand(t){this.strokeStart=this.getIsoTimestamp(),this.clearInk(),this.strokePoly=new google.maps.Polyline({map:this.map,clickable:!1,strokeColor:"#8B0000",strokeWeight:2}),this.strokePoly.getPath().push(t),this.moveListener=google.maps.event.addListener(this.map,"mousemove",(t=>{this.strokePoly.getPath().push(t.latLng)})),google.maps.event.addListenerOnce(this.map,"mouseup",(t=>{this.strokeEnd=this.getIsoTimestamp(),this.moveListener&&google.maps.event.removeListener(this.moveListener),this.enableDragZoom();let e=this.strokePoly.getPath();1==e.getLength()&&e.push(e.getAt(0));let o=e.getArray().map((t=>new a(t.lat(),t.lng()))),i={width:document.getElementById("map").clientWidth,height:document.getElementById("map").clientHeight},n=this.map.getBounds();if(!n)throw new Error("Failed to retrieve the map bounds - unable to send ink to STP");this.onStrokeCompleted&&this.onStrokeCompleted(new l(i.width,i.height),new a(n.getNorthEast().lat(),n.getSouthWest().lng()),new a(n.getSouthWest().lat(),n.getNorthEast().lng()),o,this.strokeStart,this.strokeEnd,[])}))}enableDrawing(){this.map.setOptions({draggable:!1,zoomControl:!1,scrollwheel:!1,disableDoubleClickZoom:!1})}enableDragZoom(){this.map.setOptions({draggable:!0,zoomControl:!0,scrollwheel:!0,disableDoubleClickZoom:!0})}addFeature(t){t&&this.map.data.addGeoJson(t)}removeFeature(t){let e=this.map.data.getFeatureById(t);if(e){if(this.assets.has(t)){let e=this.assets.get(t);for(let t=0;t<e.length;t++)e[t].setMap(null)}this.map.data.remove(e)}}displayInfo(t,e,o){let i=document.createElement("div");i.innerHTML=t;let n={lat:e.lat,lng:e.lon},s=new google.maps.InfoWindow({content:i,position:n});if(s&&o&&o.length)for(let t=0;t<o.length;t++){let e=i.querySelector(o[t].selector);e&&o[t].handler&&e.addEventListener("click",(e=>{o[t].closeInfo&&s.close(),o[t].handler(e)}))}s.open(this.map)}clearInk(){this.strokePoly?.setMap(null)}getBounds(){return this.map.getBounds()}getIsoTimestamp(){return(new Date).toISOString()}}let E,k,T="<Enter your Azure Speech subscription key here>",I="<Enter Azure's subscription region>",P=null,C="<Enter your Google Maps API key here>",z=new a(58.967774948,11.196062412),L=13,R="ws://<STP server>:<STP port>";function A(t,e,o){o&&alert(t);let i=document.getElementById("messages");if(!i)throw new Error("Html page must contain a 'messages' div");i.innerHTML=t,i.style.color="Error"===e?"red":"black"}window.onload=()=>async function(){const t=new URLSearchParams(window.location.search),e=t.get("mapkey");e&&(C=e);const o=t.get("lat"),i=t.get("lon");o&&i&&(z=new a(parseFloat(o),parseFloat(i)));const s=t.get("zoom");s&&(L=parseInt(s));const r=t.get("azkey");r&&(T=r);const l=t.get("azregion");l&&(I=l);t.get("azlang");const c=t.get("azendp");c&&(P=c);const d=t.get("stpurl");d&&(R=d);const g=new u(R);E=new h(g),E.onSymbolAdded=(t,e)=>{let o=new m(t[0]).asGeoJSON();k.addFeature(o)},E.onSymbolModified=(t,e,o)=>{k.removeFeature(t);let i=new m(e).asGeoJSON();k.addFeature(i)},E.onSymbolDeleted=(t,e)=>{k.removeFeature(t)},E.onInkProcessed=()=>{k.clearInk()},E.onSpeechRecognized=t=>{let e="";t&&t.length>0&&(e=t[0]),A(e)},E.onStpMessage=(t,e)=>{A(t,e,!0)};try{await E.connect("GoogleMapsSample",10)}catch(t){return void A("Failed to connect to STP at "+R+". \nSymbols will not be recognized. Please reload to try again",n.Error,!0)}k=new b(C,"map",z,L),k.onStrokeStart=(t,e)=>{E.sendPenDown(t,e),async function(){try{const t=new p.AzureSpeechRecognizer(T,I,P);let e=await t.recognizeOnce();e&&(E.sendSpeechRecognition(e.results,e.startTime,e.endTime),e.results&&e.results.length>0&&A(e.results[0].text))}catch(t){A("Failed to process speech: "+t.message)}}()},k.onStrokeCompleted=(t,e,o,i,n,s,r)=>{E.sendInk(t,e,o,i,n,s,r)},k.onSelection=t=>{let e=function(t){if(!t||!t.location||!t.location.centroid)return null;let e='<h3 id="firstHeading" class="firstHeading">'+t.fullDescription+"</h3><table><tr><td>2525D PartA</td><td>"+t.sidc?.partA+"</td></tr><tr><td>2525D PartB</td><td>"+t.sidc?.partB+"</td></tr><tr><td>Symbol Set</td><td>"+t.sidc?.symbolSet+"</td></tr><tr><td>2525C SIDC</td><td>"+t.sidc?.legacy+"</td></tr><tr><td>Affiliation</td><td>"+t.affiliation+"</td></tr>";"unit"==t.fsTYPE&&(e+="<tr><td>Echelon</td><td>"+t.echelon+"</td></tr>");e+="<tr><td>Parent Unit</td><td>"+t.parent+"</td></tr><tr><td>Designator 1</td><td>"+t.designator1+"</td></tr><tr><td>Designator 2</td><td>"+t.designator2+"</td></tr><tr><td>Status</td><td>"+t.status+"</td></tr>","unit"==t.fsTYPE&&(e+="<tr><td>Modifier</td><td>"+t.modifier+"</td></tr><tr><td>Strength</td><td>"+t.strength+"</td></tr>");return e+="<tr><td>Time From</td><td>"+t.timeFrom+"</td></tr><tr><td>Time To</td><td>"+t.timeTo+"</td></tr><tr><td>Altitude</td><td>"+t.altitude+"</td></tr><tr><td>Min Altitude</td><td>"+t.minAltitude+"</td></tr><tr><td>Max Altitude</td><td>"+t.maxAltitude+'</td></tr><tr><td><button id="delButton">Delete</button></td></tr></table>',e}(t);e&&t&&t.poid&&t.location&&t.location.centroid&&k.displayInfo(e,t.location.centroid,[{selector:"#delButton",handler:e=>{E.deleteSymbol(t.poid)},closeInfo:!0}])},k.load()}()}(SpeechSDK);